
[
  {
    "affirmationLabel": "Daily Affirmation",
    "affirmationURL": "",
    "dioceseICS": "https://www.lectionarypage.net/Resources/LiturgicalCalendar.ics",
    "affirmationText": "May these days remind us: God’s love is present in every season."
  },

  { "id": "first-sunday-carry-in", "title": "First Sunday Carry-In Dinner", "location": "Parish Hall — Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=MONTHLY;BYDAY=SU;BYSETPOS=1", "dtstart": "2025-01-05T12:00:00" }, "durationMinutes": 90 },

  { "id": "aa-148-tue", "title": "AA Group 148", "location": "Parish Hall — Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=WEEKLY;BYDAY=TU", "dtstart": "2025-01-07T19:00:00" }, "durationMinutes": 60 },
  { "id": "aa-147-fri", "title": "AA Group 147", "location": "Parish Hall — Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=WEEKLY;BYDAY=FR", "dtstart": "2025-01-03T19:00:00" }, "durationMinutes": 60 },
  { "id": "na-thu", "title": "NA (Narcotics Anonymous)", "location": "Parish Hall — Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=WEEKLY;BYDAY=TH", "dtstart": "2025-01-09T19:00:00" }, "durationMinutes": 60 },
  { "id": "na-sun", "title": "NA (Narcotics Anonymous)", "location": "Parish Hall — Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=WEEKLY;BYDAY=SU", "dtstart": "2025-01-05T17:30:00" }, "durationMinutes": 60 },

  { "id": "new-years-2025", "title": "New Year's Day (State/Federal)", "location": "USA/Missouri", "timeZone": "America/Chicago", "start": "2025-01-01T00:00:00", "durationMinutes": 0 },
  { "id": "mlk-2025", "title": "Martin Luther King, Jr.’s Birthday (State/Federal)", "location": "USA/Missouri", "timeZone": "America/Chicago", "start": "2025-01-20T00:00:00", "durationMinutes": 0 },
  { "id": "lincoln-2025", "title": "Lincoln's Birthday (Missouri)", "location": "Missouri, USA", "timeZone": "America/Chicago", "start": "2025-02-12T00:00:00", "durationMinutes": 0 },
  { "id": "washington-2025", "title": "Washington's Birthday (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-02-17T00:00:00", "durationMinutes": 0 },
  { "id": "truman-day-2025", "title": "Truman Day (Missouri)", "location": "Missouri, USA", "timeZone": "America/Chicago", "start": "2025-05-08T00:00:00", "durationMinutes": 0 },
  { "id": "memorial-2025", "title": "Memorial Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-05-26T00:00:00", "durationMinutes": 0 },
  { "id": "juneteenth-2025", "title": "Juneteenth (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-06-19T00:00:00", "durationMinutes": 0 },
  { "id": "independence-2025", "title": "Independence Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-07-04T00:00:00", "durationMinutes": 0 },
  { "id": "labor-2025", "title": "Labor Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-09-01T00:00:00", "durationMinutes": 0 },
  { "id": "columbus-2025", "title": "Columbus Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-10-13T00:00:00", "durationMinutes": 0 },
  { "id": "veterans-2025", "title": "Veterans Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-11-11T00:00:00", "durationMinutes": 0 },
  { "id": "thanksgiving-2025", "title": "Thanksgiving Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-11-27T00:00:00", "durationMinutes": 0 },
  { "id": "christmas-2025", "title": "Christmas Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-12-25T00:00:00", "durationMinutes": 0 }
]
</script>


<!-- ===== (2) index.html — drop this before </body>  ===== -->
<script>
  // ***** BUMP THIS NUMBER ANY TIME events.json OR THIS SCRIPT CHANGES *****
  const ASSETS_VERSION = 240;

  // Where to load events from (no leading slash)
  const EVENTS_URLS = [
    'assets/events.json?v=' + ASSETS_VERSION,
    'admin/events.json?v=' + ASSETS_VERSION // optional fallback if using CMS
  ];

  // Basic router state
  const state = { year: 0, month: 0 }; // month 0–11

  // ---- Fetch helpers ----
  async function loadEvents() {
    const attempts = EVENTS_URLS.map(url =>
      fetch(url, { cache: 'no-store' }).then(r => {
        if (!r.ok) throw new Error(url + ' ' + r.status);
        return r.json();
      })
    );
    // Try fastest path
    try { return await Promise.any(attempts); } catch {}
    // Fallback: try serially
    for (const url of EVENTS_URLS) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (r.ok) return await r.json();
      } catch {}
    }
    throw new Error('No events.json sources reachable');
  }

  // ---- Date helpers ----
  const pad = n => String(n).padStart(2, '0');
  const TZ_DEFAULT = 'America/Chicago';

  function addMinutes(iso, mins) {
    const d = new Date(iso);
    d.setMinutes(d.getMinutes() + (mins || 0));
    return d.toISOString();
  }

  // Expand minimal RRULEs (WEEKLY, MONTHLY with BYDAY & BYSETPOS=1..5)
  function expandRecurrence(ev, rangeStartISO, rangeEndISO) {
    const out = [];
    if (!ev.recurrence) return out;
    const { rrule, dtstart } = ev.recurrence;
    if (!rrule || !dtstart) return out;

    const start = new Date(rangeStartISO);
    const end   = new Date(rangeEndISO);

    const rule = Object.fromEntries(rrule.split(';').map(kv => kv.split('=')));
    const freq = rule.FREQ;

    if (freq === 'WEEKLY') {
      const byday = (rule.BYDAY || '').split(','); // e.g., ["TU"]
      // start from the week of dtstart
      let cursor = new Date(dtstart);
      // move cursor back to range start if needed
      if (cursor < start) cursor = new Date(start);

      const weekdayIndex = { SU:0, MO:1, TU:2, WE:3, TH:4, FR:5, SA:6 };

      while (cursor <= end) {
        for (const code of byday) {
          const inst = new Date(cursor);
          const want = weekdayIndex[code];
          const diff = (want - inst.getDay() + 7) % 7;
          inst.setDate(inst.getDate() + diff);
          const instanceISO = new Date(
            inst.getFullYear(), inst.getMonth(), inst.getDate(),
            new Date(dtstart).getHours(), new Date(dtstart).getMinutes(), 0
          ).toISOString();
          if (inst >= start && inst <= end) {
            out.push({ start: instanceISO, end: addMinutes(instanceISO, ev.durationMinutes || 60) });
          }
        }
        cursor.setDate(cursor.getDate() + 7); // next week
      }
    }

    if (freq === 'MONTHLY') {
      const byday = (rule.BYDAY || '').split(','); // e.g., ["SU"]
      const bysetpos = parseInt(rule.BYSETPOS || '1', 10); // e.g., 1 = first
      let cursor = new Date(dtstart);
      if (cursor < start) cursor = new Date(start);

      const weekdayIndex = { SU:0, MO:1, TU:2, WE:3, TH:4, FR:5, SA:6 };

      while (cursor <= end) {
        const y = cursor.getFullYear();
        const m = cursor.getMonth();
        for (const code of byday) {
          // find the Nth weekday of the month
          const firstOfMonth = new Date(y, m, 1);
          const firstDow = firstOfMonth.getDay();
          const want = weekdayIndex[code];
          const day = 1 + ((want - firstDow + 7) % 7) + (bysetpos - 1) * 7;
          const inst = new Date(y, m, day, new Date(dtstart).getHours(), new Date(dtstart).getMinutes(), 0);
          if (inst >= start && inst <= end && inst.getMonth() === m) {
            const instanceISO = inst.toISOString();
            out.push({ start: instanceISO, end: addMinutes(instanceISO, ev.durationMinutes || 60) });
          }
        }
        // next month
        cursor = new Date(y, m + 1, 1);
      }
    }

    return out;
  }

  // ---- Google link helper ----
  function toGoogleUTC(dt) {
    const d = new Date(dt);
    return (
      d.getUTCFullYear() +
      pad(d.getUTCMonth() + 1) +
      pad(d.getUTCDate()) + 'T' +
      pad(d.getUTCHours()) +
      pad(d.getUTCMinutes()) + '00Z'
    );
  }

  function googleLink(ev, startISO, endISO) {
    const text = encodeURIComponent(ev.title);
    const dates = `${toGoogleUTC(startISO)}/${toGoogleUTC(endISO)}`;
    const loc = encodeURIComponent(ev.location || '');
    const tz = encodeURIComponent(ev.timeZone || TZ_DEFAULT);
    const det = encodeURIComponent('Trinity Episcopal De Soto — Calendar');
    return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&location=${loc}&details=${det}&ctz=${tz}`;
  }

  // ---- Today button ----
  function goTo(y, m) {
    state.year = y; state.month = m; render?.(); // assumes you already have render()
    location.hash = `#/${y}/${String(m + 1).padStart(2, '0')}`;
  }
  function goToToday() {
    const now = new Date();
    goTo(now.getFullYear(), now.getMonth());
  }
  document.querySelector('[data-btn="today"]')?.addEventListener('click', goToToday);
  if (!location.hash) goToToday();

  // ---- Example hook during render (pseudo):
  // When you render an expanded event instance, add the Google button like this:
  // const a = document.createElement('a');
  // a.href = googleLink(ev, instance.start, instance.end);
  // a.target = '_blank';
  // a.rel = 'noopener';
  // a.textContent = 'Add to Google';
  // card.appendChild(a);

  // Optional: quick probe in console to debug fetch
  window._probeEvents = async () => {
    const u = 'assets/events.json?probe=' + Date.now();
    const r = await fetch(u, { cache: 'no-store' });
    const t = await r.text();
    console.log('status', r.status, 'bytes', t.length);
    try { JSON.parse(t); console.log('JSON OK'); } catch(e) { console.warn('JSON parse error', e); }
  };
</script>
