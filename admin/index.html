<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trinity Church Calendar of Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --panel:#ffffff; --ink:#0b1220; --muted:#475569;
      --accent:#16a34a; --accent-2:#2563eb;
      --grid:#cbd5e1; --tint:#f8fafc;
    }
    body {margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:var(--tint);}
    header {
      background:url("assets/stained-glass.jpg") center/cover no-repeat;
      color:#fff; padding:2rem 1rem; text-align:center;
      font-size:2rem; font-weight:bold;
      text-shadow:1px 1px 4px rgba(0,0,0,0.7);
    }
    #calendar {max-width:1000px;margin:1rem auto;padding:1rem;background:var(--panel);border-radius:1rem;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    #calendar table {width:100%;border-collapse:collapse;}
    #calendar th,#calendar td {border:1px solid var(--grid);text-align:center;vertical-align:top;padding:.5rem;min-height:5rem;}
    #calendar th {background:var(--tint);}
    .event {margin:.25rem 0;padding:.25rem .5rem;border-radius:.5rem;font-size:.8rem;}
    .svc {background:#e0f2fe;color:#0369a1;}
    .aa {background:#fef9c3;color:#92400e;}
    .na {background:#fce7f3;color:#9d174d;}
    .holy {background:#dcfce7;color:#166534;}
    .diocesan {
  background: #e0e7ff; /* light blue */
  color: #1e3a8a;      /* navy text */
}

    .liturgical {display:inline-block;margin-left:.5rem;padding:.1rem .5rem;border-radius:.5rem;font-size:.8rem;color:#fff;}
    #nav {display:flex;justify-content:center;gap:1rem;margin:1rem;}
    #nav button {padding:.5rem 1rem;border:none;border-radius:.5rem;background:var(--accent);color:#fff;cursor:pointer;font-weight:bold;}
    #nav button:hover {background:#15803d;}
    #upcoming {max-width:1000px;margin:1rem auto;padding:1rem;}
  </style>
</head>
<body>
  <header>Trinity Church Calendar of Events</header>

  <div id="nav">
    <button onclick="changeMonth(-1)">◀ Prev</button>
    <button onclick="goToday()">Today</button>
    <button onclick="changeMonth(1)">Next ▶</button>
  </div>

  <div id="calendar"></div>
  <p style="text-align:center; margin-top:1rem;">
  <a href="https://www.diocesemo.org/calendar" target="_blank" 
     style="display:inline-block; background:var(--accent); color:#fff; 
            padding:0.5rem 1rem; border-radius:0.5rem; text-decoration:none; 
            font-weight:600; font-size:0.95rem;">
    View Full Diocesan Calendar →
  </a>
</p>

  <div id="upcoming">
    <h2>Upcoming Events</h2>
    <ul id="upcoming-list"></ul>
  </div>

<script>
const ASSETS_VERSION = 318;
const EVENTS_URLS = [
  `/assets/events.json?v=${ASSETS_VERSION}`,
  `/assets/liturgical.json?v=${ASSETS_VERSION}`
];

let events = [];
let liturgical = [];
let currentDate = new Date();

async function loadEvents() {
  for (const url of EVENTS_URLS) {
    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error("HTTP " + r.status);
     if (url.includes("liturgical")) {
  liturgical = await r.json();
} else {
  const more = await r.json();
  events = events.concat(more);
}

    } catch (e) {
      console.error("Failed to load", url, e);
    }
  }
  renderCalendar(currentDate);
}

function changeMonth(offset) {
  currentDate.setMonth(currentDate.getMonth() + offset);
  renderCalendar(currentDate);
}

function goToday() {
  currentDate = new Date();
  renderCalendar(currentDate);
}

function renderCalendar(date) {
  const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
  const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
  const weeks = [];
  let current = new Date(monthStart);
  current.setDate(current.getDate() - current.getDay());

  while (current <= monthEnd || current.getDay() !== 0) {
    const week = [];
    for (let d = 0; d < 7; d++) {
      week.push(new Date(current));
      current.setDate(current.getDate() + 1);
    }
    weeks.push(week);
  }

  const lit = liturgical.find(l => new Date(l.start) <= monthEnd && new Date(l.end) >= monthStart);
  const litChip = lit ? `<span class="liturgical" style="background:${lit.color}">${lit.name}</span>` : "";

  let html = `<h2>${monthStart.toLocaleString('default',{month:'long'})} ${monthStart.getFullYear()} ${litChip}</h2>`;
  html += `<table><thead><tr>`;
  ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d => html += `<th>${d}</th>`);
  html += `</tr></thead><tbody>`;
  for (const week of weeks) {
    html += `<tr>`;
    for (const day of week) {
      const inMonth = day.getMonth() === monthStart.getMonth();
      html += `<td${inMonth?"":' style="background:#f1f5f9"'}>`;
      if (inMonth) {
        html += `<div>${day.getDate()}</div>`;
        const dayEvents = events.filter(ev => occursOn(ev, day));
        for (const ev of dayEvents) {
          html += `<div class="event ${ev.type||''}">${ev.title}</div>`;
        }
      }
      html += `</td>`;
    }
    html += `</tr>`;
  }
  html += `</tbody></table>`;
  document.getElementById("calendar").innerHTML = html;

  const upcoming = [];
  const today = new Date();
  for (let i = 0; i < 30; i++) {
    const day = new Date(today);
    day.setDate(today.getDate() + i);
    const dayEvents = events.filter(ev => occursOn(ev, day));
    for (const ev of dayEvents) {
      upcoming.push(`${day.toLocaleDateString()} — ${ev.title}`);
    }
  }
  document.getElementById("upcoming-list").innerHTML = upcoming.map(e => `<li>${e}</li>`).join("");
}

function occursOn(ev, day) {
  const d = day.toISOString().split("T")[0];
  if (ev.start) {
    const evDate = ev.start.split("T")[0];
    return evDate === d;
  }
  if (ev.rrule) {
    return matchesRRule(ev.rrule, day);
  }
  return false;
}

function matchesRRule(rrule, day) {
  const [freqPart,...rest] = rrule.split(";");
  const freq = freqPart.split("=")[1];
  const dayStr = ["SU","MO","TU","WE","TH","FR","SA"][day.getDay()];
  if (freq==="WEEKLY" && rest.some(p=>p.includes("BYDAY="+dayStr))) return true;
  if (freq==="MONTHLY" && rest.some(p=>p.includes("BYDAY="+dayStr)) && rest.some(p=>p.includes("BYSETPOS=1")) && day.getDate()<=7) return true;
  return false;
}

loadEvents();
</script>
</body>
</html>
