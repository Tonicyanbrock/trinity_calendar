<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trinity Church Calendar of Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      background: #f8fafc;
      color: #111;
    }

    /* ===== Banner ===== */
    .calendar-header {
      background: url("assets/stained-glass.jpg") no-repeat center/cover;
      height: 160px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      text-align: center;
    }
    .calendar-header .overlay {
      background: rgba(220, 38, 38, 0.65); /* pink-red tint overlay */
      padding: 1rem 2rem;
      border-radius: 10px;
      font-size: 1.8rem;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.9);
    }

    /* ===== Calendar styles ===== */
    .app { 
      max-width: 980px;
      margin: 20px auto;
      padding: 12px;
    }
    .header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 10px;
      align-items: center;
      margin-top: 1rem;
    }
    h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      text-align: center;
    }
    .btn {
      background: #2563eb;
      color: white;
      padding: 6px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover { background: #1e40af; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #cbd5e1;
      text-align: left;
      vertical-align: top;
      padding: .25rem;
      min-width: 6rem;
      height: 5rem;
    }
    td .daynum { font-weight: bold; }
    .today { background: #16a34a; color: white; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { margin: .1rem 0; font-size: .75rem; }
    .upcoming { margin-top: 1rem; }
    .legend { margin-top: 20px; font-size: 13px; }
    .legend span { margin-right: 10px; padding: 2px 6px; border-radius: 6px; color: white; }
    .legend .aa { background: #22c55e; }
    .legend .na { background: #f97316; }
    .legend .svc { background: #475569; }
    .legend .holy { background: #eab308; }
    .debug { margin-top: 20px; font-size: 12px; color: #475569; }
  </style>
</head>
<body>

  <!-- Banner -->
  <header class="calendar-header">
    <div class="overlay">Trinity Church Calendar of Events</div>
  </header>

  <!-- Calendar App -->
  <div class="app">
    <div class="header">
      <button class="btn" data-btn="prev">◀</button>
      <h1 id="month-label"></h1>
      <button class="btn" data-btn="next">▶</button>
    </div>

    <div style="text-align:center;margin:10px 0;">
      <button class="btn" data-btn="today">Today</button>
      <button class="btn" onclick="window.print()">Print</button>
    </div>

    <div id="calendar"></div>
    <div id="upcoming"></div>

    <div class="legend">
      <strong>Legend:</strong>
      <span class="aa">AA</span>
      <span class="na">NA</span>
      <span class="svc">Sunday Service</span>
      <span class="holy">Holy Day</span>
    </div>

    <div class="debug" id="debug"></div>
  </div>

  <script>
    const ASSETS_VERSION = 304;
    const EVENTS_URLS = [
      "assets/events.json?v=" + ASSETS_VERSION,
      "admin/events.json?v=" + ASSETS_VERSION
    ];

    const state = { year:0, month:0, events:[] };

    function startOfMonth(y,m){ return new Date(y,m,1);}
    function endOfMonth(y,m){ return new Date(y,m+1,0);}
    function pad(n){return String(n).padStart(2,"0");}
    function fmtDate(d){return d.toLocaleDateString(undefined,{month:"short",day:"numeric"});}

    async function loadEvents(){
      let all=[];
      for(const url of EVENTS_URLS){
        try{
          const resp=await fetch(url,{cache:"no-store"});
          if(resp.ok){
            const data=await resp.json();
            all=all.concat(data);
          }
        }catch(e){console.error("Failed load",url,e);}
      }
      return all;
    }

    function render(events){
      const today=new Date();
      const y=state.year, m=state.month;
      const rangeStart=startOfMonth(y,m), rangeEnd=endOfMonth(y,m);

      // group events
      let grouped={};
      events.forEach(ev=>{
        let dateKey=(ev.start||"").split("T")[0];
        if(dateKey){
          if(!grouped[dateKey]) grouped[dateKey]=[];
          grouped[dateKey].push(ev);
        }
      });

      // Month label
      document.getElementById("month-label").textContent =
        rangeStart.toLocaleString("default",{month:"long"})+" "+y;

      // Grid
      let table="<table><tr>";
      ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>table+=`<th>${d}</th>`);
      table+="</tr><tr>";
      for(let i=0;i<rangeStart.getDay();i++) table+="<td></td>";
      for(let d=1;d<=rangeEnd.getDate();d++){
        let dateStr=`${y}-${pad(m+1)}-${pad(d)}`;
        let classes=(d===today.getDate() && m===today.getMonth() && y===today.getFullYear())?"today":"";
        table+=`<td class="${classes}"><div class="daynum">${d}</div>`;
        if(grouped[dateStr]){
          table+="<ul>";
          grouped[dateStr].forEach(ev=>{
            table+=`<li>${ev.title}</li>`;
          });
          table+="</ul>";
        }
        table+="</td>";
        if((rangeStart.getDay()+d)%7===0) table+="</tr><tr>";
      }
      table+="</tr></table>";
      document.getElementById("calendar").innerHTML=table;

      // Upcoming
      let upcoming=events.slice(0,10).map(ev=>`<li>${fmtDate(new Date(ev.start))} — ${ev.title}</li>`).join("");
      document.getElementById("upcoming").innerHTML=`<h3>Upcoming Events</h3><ul>${upcoming}</ul>`;
    }

    document.querySelector("[data-btn='prev']").onclick=()=>{
      state.month--; if(state.month<0){state.month=11;state.year--;} render(state.events);
    };
    document.querySelector("[data-btn='next']").onclick=()=>{
      state.month++; if(state.month>11){state.month=0;state.year++;} render(state.events);
    };
    document.querySelector("[data-btn='today']").onclick=()=>{
      const now=new Date(); state.year=now.getFullYear(); state.month=now.getMonth(); render(state.events);
    };

    (async()=>{
      try {
        const ev=await loadEvents();
        state.events=ev;
        const now=new Date(); state.year=now.getFullYear(); state.month=now.getMonth();
        render(ev);
        document.getElementById("debug").textContent=`OK: events loaded (${ev.length} total)`;
      } catch(e){
        document.getElementById("debug").textContent="⚠️ "+e.message;
      }
    })();
  </script>
</body>
</html>
