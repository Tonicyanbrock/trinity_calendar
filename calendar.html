<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trinity Episcopal Church — Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family: ui-sans-serif, system-ui, sans-serif; background:#f8fafc; color:#111; }
    header {
      background: url("assets/stained-glass.jpg") center/cover no-repeat;
      padding: 2rem;
      text-align: center;
      color: white;
      font-size: 1.8rem;
      font-weight: bold;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.6);
    }
    #calendar { max-width: 960px; margin: 1rem auto; padding: 1rem; background:white; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #ddd; padding:6px; vertical-align:top; width:14%; height:90px; }
    th { background:#f1f5f9; }
    .today { background:#2563eb; color:white; }
    .daynum { font-weight:bold; }
    ul { margin:0; padding-left:14px; font-size:0.8rem; }
    #upcoming { max-width:960px; margin:1rem auto; padding:1rem; background:white; border-radius:12px; }
  </style>
</head>
<body>
  <header>Trinity Church Calendar of Events</header>
  <div id="calendar"></div>
  <div id="upcoming"></div>

<script>
const ASSETS_VERSION = 313;  // bump number
const EVENTS_URLS = [
  'assets/events.json?v=' + ASSETS_VERSION,
  'admin/events.json?v=' + ASSETS_VERSION
];

const state = { year:0, month:0, events:[] };

function startOfMonth(y,m){ return new Date(y,m,1);}
function endOfMonth(y,m){ return new Date(y,m+1,0);}
function pad(n){return String(n).padStart(2,'0');}
function formatDate(d){return d.toLocaleDateString("en-US",{month:"short",day:"numeric"});}

function expandRrule(event, rangeStart, rangeEnd) {
  if (!event.rrule) return [];
  const rules = {};
  event.rrule.split(";").forEach(p => { const [k,v]=p.split("="); rules[k]=v; });
  const freq = rules.FREQ;
  const hour = parseInt(rules.BYHOUR||"0");
  const minute = parseInt(rules.BYMINUTE||"0");
  let dates=[];
  if (freq==="WEEKLY" && rules.BYDAY) {
    const dayMap={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6};
    const target=dayMap[rules.BYDAY];
    let d=new Date(rangeStart);
    d.setDate(d.getDate()+((7+target-d.getDay())%7));
    while(d<=rangeEnd){
      dates.push(new Date(d.getFullYear(),d.getMonth(),d.getDate(),hour,minute));
      d.setDate(d.getDate()+7);
    }
  }
  if (freq==="MONTHLY" && rules.BYDAY && rules.BYSETPOS) {
    const dayMap={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6};
    const target=dayMap[rules.BYDAY];
    const setpos=parseInt(rules.BYSETPOS);
    for(let m=rangeStart.getMonth(); m<=rangeEnd.getMonth(); m++){
      let count=0;
      for(let i=1;i<=31;i++){
        let test=new Date(rangeStart.getFullYear(),m,i);
        if(test.getMonth()!==m) break;
        if(test.getDay()===target){
          count++;
          if(count===setpos){
            dates.push(new Date(test.getFullYear(),test.getMonth(),test.getDate(),hour,minute));
          }
        }
      }
    }
  }
  return dates;
}

async function loadEvents(){
  let all=[];
  for(const url of EVENTS_URLS){
    try{
      const resp=await fetch(url,{cache:"no-store"});
      if(resp.ok){
        const data=await resp.json();
        all=all.concat(data);
      }
    }catch(e){console.error("Failed to load",url,e);}
  }
  return all;
}

function render(events){
  const today=new Date();
  const y=today.getFullYear(), m=today.getMonth();
  const start=startOfMonth(y,m), end=endOfMonth(y,m);
  // expand recurrences
  let expanded=[];
  events.forEach(ev=>{
    if(ev.date){expanded.push(ev);}
    else if(ev.rrule){
      expandRrule(ev,start,end).forEach(d=>{
        expanded.push({...ev,date:d});
      });
    }
  });
  // group
  let grouped={};
  expanded.forEach(ev=>{
    let key=ev.date.toDateString();
    if(!grouped[key]) grouped[key]=[];
    grouped[key].push(ev);
  });
  // render table
  let cal="<table><tr>";
  ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d=>cal+=`<th>${d}</th>`);
  cal+="</tr><tr>";
  let startDay=start.getDay();
  for(let i=0;i<startDay;i++) cal+="<td></td>";
  for(let d=1; d<=end.getDate(); d++){
    let thisDay=new Date(y,m,d);
    let key=thisDay.toDateString();
    let classes=thisDay.toDateString()===today.toDateString()?"today":"";
    cal+=`<td class="${classes}"><div class="daynum">${d}</div>`;
    (grouped[key]||[]).forEach(ev=>{
      cal+=`<div style="font-size:0.8rem;margin:2px 0;">${ev.title}</div>`;
    });
    cal+="</td>";
    if((startDay+d)%7===0) cal+="</tr><tr>";
  }
  cal+="</tr></table>";
  document.getElementById("calendar").innerHTML=cal;
  // upcoming
  let upcoming=expanded.filter(e=>e.date>=today).sort((a,b)=>a.date-b.date).slice(0,10);
  document.getElementById("upcoming").innerHTML="<h3>Upcoming Events</h3><ul>"+upcoming.map(ev=>`<li>${formatDate(ev.date)} — ${ev.title}</li>`).join("")+"</ul>";
}

(async()=>{
  const ev=await loadEvents();
  state.events=ev;
  render(ev);
})();
</script>
</body>
</html>
