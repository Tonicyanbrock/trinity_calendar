<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Trinity Episcopal De Soto â€” Calendar</title>
  <meta name="description" content="Monthly events & services at Trinity Episcopal Church, De Soto, MO. All are welcome." />
  <link rel="canonical" href="https://example.org/" />
  <meta name="theme-color" content="#0b1220" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Trinity Episcopal De Soto â€” Calendar" />
  <meta property="og:title" content="Trinity Episcopal De Soto â€” Calendar" />
  <meta property="og:description" content="Monthly events & services at Trinity Episcopal Church, De Soto, MO." />
  <meta property="og:image" content="assets/view-calendar.png?v=2" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Trinity Episcopal De Soto â€” Calendar" />
  <meta name="twitter:description" content="Monthly events & services at Trinity Episcopal Church, De Soto, MO." />
  <meta name="twitter:image" content="assets/view-calendar.png?v=2" />
const ASSETS_VERSION = '4';

  <style>
    :root{
      --panel:#ffffff; --ink:#0b1220; --muted:#475569;
      --accent:#16a34a; --accent-2:#2563eb;
      --grid:#cbd5e1; --tint:#f8fafc;
      --error:#b91c1c; --focus:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--ink);background:#fff}
    a{color:var(--accent-2);text-underline-offset:2px}
    .app{max-width:980px;margin:14px auto;padding:12px}
    .header{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    .brand h1{font-size:22px;margin:0}
    .brand small{display:block;color:var(--muted)}
    .cta img{height:44px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.15)}
    .toolbar{display:flex;gap:8px;justify-content:flex-end;align-items:center}
    button{background:#fff;color:var(--ink);border:1px solid var(--grid);padding:8px 10px;border-radius:8px;cursor:pointer}
    button:hover{background:var(--tint)}
    button:focus-visible{outline:3px solid var(--focus);outline-offset:2px}
    .monthbar{display:flex;align-items:center;gap:10px;margin:10px 0}
    .monthbar h2{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{font-weight:600;color:var(--muted);text-align:center;padding:6px 0}
    .cell{border:1px solid var(--grid);border-radius:8px;min-height:120px;padding:6px;background:#fff}
    .cell.other{background:#fafafa;color:#6b7280}
    .date{font-weight:600;font-size:12px;color:#0f172a}
    .ev{margin-top:4px;padding:4px;border-left:3px solid var(--accent-2);background:#f1f5f9;border-radius:4px}
    .ev.holiday{border-left-color:#16a34a;background:#ecfdf5}
    .ev time{font-size:12px;color:#0f172a}
    .ev .t{font-weight:600;display:block;margin:2px 0}
    .ev a.ics{font-size:12px}
    .split{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:14px}
    .card{border:1px solid var(--grid);border-radius:10px;padding:10px;background:#fff}
    .card h3{margin:0 0 6px;font-size:16px}
    .legend{display:flex;flex-wrap:wrap;gap:8px}
    .tag{border:1px dashed var(--grid);border-radius:8px;padding:4px 8px;font-size:12px;background:#fff}
    .footer{margin-top:16px;color:var(--muted);text-align:center;font-size:13px}
    .error{border:1px solid var(--error);background:#fef2f2;color:#7f1d1d;border-radius:10px;padding:10px}

    /* Print = month agenda */
    @media print{
      .toolbar,.cta,.monthbar .nav,.grid .dow,.legend,.footer{display:none !important}
      .grid{grid-template-columns:1fr}
      .cell{break-inside:avoid;border:none;border-bottom:1px solid #e5e7eb;min-height:auto}
      .date{font-size:16px}
      .ev{background:#fff;border:none;padding:0;margin:0}
      .ev .t{display:inline;font-weight:700}
      .split{display:block}
      .card{border:none;padding:0}
    }
  </style>
</head>
<body>
  <div class="app" id="app" hidden>
    <header class="header">
      <div class="brand">
        <div>
          <h1>Trinity Episcopal De Soto â€” Calendar</h1>
          <small>Monthly events &amp; services</small>
        </div>
      </div>
      <a class="cta" href="#/" aria-label="View Calendar">
        <img src="assets/view-calendar.png?v=2" alt="View Calendar" />
      </a>
      <div class="toolbar">
        <button id="btn-today" aria-label="Jump to current month">Today</button>
        <button id="btn-print" aria-label="Print this calendar">ðŸ–¨ Print Calendar</button>
      </div>
    </header>

    <div class="monthbar">
      <div class="nav">
        <button id="prev" aria-label="Previous month">â—€</button>
        <button id="next" aria-label="Next month">â–¶</button>
      </div>
      <h2 id="monthlabel" aria-live="polite"></h2>
    </div>

    <div id="err" class="error" hidden>
      <strong>Couldnâ€™t load events.</strong> Please try again:
      <button id="retry">Retry</button>
    </div>

    <section class="grid" id="dow"></section>
    <section class="grid" id="calendar" aria-live="polite"></section>

    <div class="split">
      <section class="card">
        <h3>Upcoming (next 10)</h3>
        <ul id="upcoming" aria-live="polite"></ul>
      </section>
      <section class="card">
        <h3>Legend</h3>
        <div class="legend">
          <span class="tag">Sunday Service</span>
          <span class="tag">AA Group 148</span>
          <span class="tag">AA Group 147</span>
          <span class="tag">NA</span>
          <span class="tag">Carry-In Dinner</span>
          <span class="tag">US Holidays</span>
        </div>
      </section>
    </div>

    <footer class="footer">
      Trinity Episcopal Church, 202 W. Miller Street, De Soto, MO 63020 | (636) 586-2542
    </footer>
  </div>

  <script>
  (function(){
    'use strict';

    // ---------- Config ----------
    const TZ = 'America/Chicago';
    const ASSETS_VERSION = '2';
    const EVENTS_URL = `assets/events.json?v=${ASSETS_VERSION}`;
    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const DOW_MAP = {SU:0, MO:1, TU:2, WE:3, TH:4, FR:5, SA:6};
    const fmtMonth = new Intl.DateTimeFormat('en-US',{timeZone:TZ, month:'long', year:'numeric'});
    const fmtDayNum = new Intl.DateTimeFormat('en-US',{timeZone:TZ, day:'numeric'});
    const fmtTime = new Intl.DateTimeFormat('en-US',{timeZone:TZ, hour:'numeric', minute:'2-digit'});

    const app = document.getElementById('app');
    const monthlabel = document.getElementById('monthlabel');
    const gridEl = document.getElementById('calendar');
    const dowEl = document.getElementById('dow');
    const upcomingEl = document.getElementById('upcoming');
    const errEl = document.getElementById('err');

    // ---------- Basic offline cache via tiny SW ----------
    if ('serviceWorker' in navigator) {
      const swCode = `
        const VERSION='v${ASSETS_VERSION}';
        const ASSETS=['./','index.html','assets/view-calendar.png?v=${ASSETS_VERSION}','${EVENTS_URL}'];
        self.addEventListener('install',e=>{e.waitUntil(caches.open(VERSION).then(c=>c.addAll(ASSETS)))});
        self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==VERSION&&caches.delete(k)))))});
        self.addEventListener('fetch',e=>{
          const url=new URL(e.request.url);
          if(url.origin===location.origin){
            e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
              const copy=res.clone(); caches.open(VERSION).then(c=>c.put(e.request,copy)); return res;
            }).catch(()=>r)));
          }
        });
      `;
      const blobUrl = URL.createObjectURL(new Blob([swCode],{type:'text/javascript'}));
      navigator.serviceWorker.register(blobUrl).catch(()=>{});
    }

    // ---------- Timezone helpers (DST-safe) ----------
    const dtfParts = new Intl.DateTimeFormat('en-US', {
      timeZone: TZ, hour12:false,
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit', weekday:'short'
    });
    function partsInTZ(date){
      const map={};
      dtfParts.formatToParts(date).forEach(p=>{ if(p.type!=='literal') map[p.type]=p.value; });
      map.weekdayIndex = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].indexOf(map.weekday);
      return {year:+map.year, monthIndex:+map.month-1, day:+map.day, hour:+map.hour, minute:+map.minute, second:+map.second, weekday:map.weekdayIndex};
    }
    function zonedDate(year, monthIndex, day, hour=0, minute=0, second=0){
      let d = new Date(Date.UTC(year, monthIndex, day, hour, minute, second));
      const p = partsInTZ(d);
      const wantedUTC = Date.UTC(year, monthIndex, day, hour, minute, second);
      const shownUTC  = Date.UTC(p.year, p.monthIndex, p.day, p.hour, p.minute, p.second);
      return new Date(d.getTime() + (wantedUTC - shownUTC));
    }
    function startOfMonth(y,m){ return zonedDate(y,m,1,0,0,0); }
    function nextMonth(d){ const p=partsInTZ(d); const m=(p.monthIndex+1)%12, y=p.year+(p.monthIndex===11?1:0); return zonedDate(y,m,1,0,0,0); }
    function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
    function parseLocalISO(iso){
      const [d,t='00:00'] = iso.split('T'); const [Y,M,D]=d.split('-').map(Number); const [h,mi]=t.split(':').map(Number);
      return zonedDate(Y, M-1, D, h, mi, 0);
    }

    // ---------- RRULE (minimal) ----------
    function parseRRule(s){
      const out={}; s.split(';').forEach(kv=>{const [k,v]=kv.split('='); if(k){out[k.toUpperCase()]=v;}});
      if(out.BYDAY) out.BYDAY = out.BYDAY.split(',').map(x=>x.trim().toUpperCase());
      if(out.BYHOUR) out.BYHOUR = +out.BYHOUR;
      if(out.BYMINUTE) out.BYMINUTE = +out.BYMINUTE;
      if(out.BYSETPOS) out.BYSETPOS = +out.BYSETPOS;
      if(out.FREQ) out.FREQ = out.FREQ.toUpperCase();
      return out;
    }

    function expandEventForMonth(ev, y, m){
      const events=[];
      const monthStart = startOfMonth(y,m);
      const monthEnd = nextMonth(monthStart);

      if (ev.start){ // single event
        const dt = parseLocalISO(ev.start);
        if (dt >= monthStart && dt < monthEnd) {
          const end = new Date(dt.getTime() + (ev.duration_minutes||60)*60000);
          events.push({title:ev.title, location:ev.location||'', notes:ev.notes||'', start:dt, end});
        }
        return events;
      }

      if (!ev.rrule) return events;
      const rule = parseRRule(ev.rrule);

      if (rule.FREQ==='WEEKLY'){
        const byhour = rule.BYHOUR||0, bymin = rule.BYMINUTE||0;
        const occurDOW = (rule.BYDAY?.length ? rule.BYDAY : ['SU']).map(code=>DOW_MAP[code]).filter(v=>v>=0);
        const firstParts = partsInTZ(monthStart);
        occurDOW.forEach(wd=>{
          let firstDate = 1 + ((wd - firstParts.weekday + 7) % 7);
          for (let d=firstDate; d<=daysInMonth(y,m); d+=7){
            const s = zonedDate(y, m, d, byhour, bymin, 0);
            if (s >= monthStart && s < monthEnd){
              const e = new Date(s.getTime() + (ev.duration_minutes||60)*60000);
              events.push({title:ev.title, location:ev.location||'', notes:ev.notes||'', start:s, end:e});
            }
          }
        });
      }

      // Upgraded monthly: BYDAY + BYSETPOS (1..5 or -1 for last)
      if (rule.FREQ==='MONTHLY' && rule.BYDAY){
        const byhour = rule.BYHOUR||0, bymin = rule.BYMINUTE||0;
        const code = Array.isArray(rule.BYDAY) ? rule.BYDAY[0] : rule.BYDAY;
        const dow = DOW_MAP[code];
        let s=null;

        if (rule.BYSETPOS===-1){
          const dim = daysInMonth(y,m);
          const last = zonedDate(y, m, dim, byhour, bymin, 0);
          const w = partsInTZ(last).weekday;
          const day = dim - ((w - dow + 7) % 7);
          s = zonedDate(y, m, day, byhour, bymin, 0);
        } else {
          const n = Math.max(1, Math.min(5, rule.BYSETPOS||1));
          const first = zonedDate(y, m, 1, byhour, bymin, 0);
          const w = partsInTZ(first).weekday;
          const day = 1 + ((dow - w + 7) % 7) + (n-1)*7;
          if (day <= daysInMonth(y,m)) s = zonedDate(y, m, day, byhour, bymin, 0);
        }

        if (s && s >= monthStart && s < monthEnd){
          const e = new Date(s.getTime() + (ev.duration_minutes||60)*60000);
          events.push({title:ev.title, location:ev.location||'', notes:ev.notes||'', start:s, end:e});
        }
      }

      return events;
    }

    // ---------- US Federal Holidays (auto) ----------
    function nthDowOfMonth(year, monthIndex, dow, n){
      const first = zonedDate(year, monthIndex, 1, 0, 0, 0);
      const w = partsInTZ(first).weekday;
      const day = 1 + ((dow - w + 7) % 7) + (n-1)*7;
      return zonedDate(year, monthIndex, day, 0, 0, 0);
    }
    function lastDowOfMonth(year, monthIndex, dow){
      const dim = daysInMonth(year, monthIndex);
      const last = zonedDate(year, monthIndex, dim, 0, 0, 0);
      const w = partsInTZ(last).weekday;
      const day = dim - ((w - dow + 7) % 7);
      return zonedDate(year, monthIndex, day, 0, 0, 0);
    }
    function fixedDate(year, monthIndex, day){ return zonedDate(year, monthIndex, day, 0, 0, 0); }
    function usFederalHolidaysForMonth(year, monthIndex){
      const H = [];
      const add = (title, dt)=>H.push({title:`Holiday â€” ${title}`, location:'', notes:'', start:dt, end:new Date(dt.getTime()+24*60*60000), _holiday:true});
      add("New Year's Day", fixedDate(year,0,1));
      add("Martin Luther King Jr. Day", nthDowOfMonth(year,0,1,3));
      add("Washingtonâ€™s Birthday",      nthDowOfMonth(year,1,1,3));
      add("Memorial Day",               lastDowOfMonth(year,4,1));
      add("Juneteenth National Independence Day", fixedDate(year,5,19));
      add("Independence Day", fixedDate(year,6,4));
      add("Labor Day", nthDowOfMonth(year,8,1,1));
      add("Columbus/Indigenous Peoplesâ€™ Day", nthDowOfMonth(year,9,1,2));
      add("Veterans Day", fixedDate(year,10,11));
      add("Thanksgiving Day", nthDowOfMonth(year,10,4,4));
      add("Christmas Day", fixedDate(year,11,25));
      return H.filter(e=>partsInTZ(e.start).year===year && partsInTZ(e.start).monthIndex===monthIndex);
    }

    // Hook holidays into month expansion
    const _expandAllForMonth_orig = expandAllForMonth;
    function expandAllForMonth(y,m){
      const base = _expandAllForMonth_orig ? _expandAllForMonth_orig(y,m) : (function(){
        const acc=[]; (window.RAW?.events||[]).forEach(ev=>expandEventForMonth(ev,y,m).forEach(x=>acc.push(x))); return acc;
      })();
      base.push(...usFederalHolidaysForMonth(y,m));
      return base;
    }

    // ---------- ICS ----------
    const fmtICS = new Intl.DateTimeFormat('en-US',{
      timeZone:TZ,hour12:false,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'
    });
    function icsLocal(date){
      const p = fmtICS.formatToParts(date).reduce((a,b)=>{a[b.type]=b.value;return a;},{});
      return `${p.year}${p.month}${p.day}T${p.hour}${p.minute}${p.second}`;
    }
    function hashId(s){ let h=0; for(let i=0;i<s.length;i++){h=(h*31 + s.charCodeAt(i))|0;} return (h>>>0).toString(16); }
    function makeICS(evt){
      const uid = `trinity-${hashId(evt.title + evt.start.getTime() + (evt.location||''))}@trinity-desoto`;
      const lines = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Trinity Episcopal De Soto//Calendar//EN','CALSCALE:GREGORIAN','METHOD:PUBLISH',
        'BEGIN:VEVENT',
        `UID:${uid}`,
        `SUMMARY:${evt.title}`,
        `DTSTART;TZID=${TZ}:${icsLocal(evt.start)}`,
        `DTEND;TZID=${TZ}:${icsLocal(evt.end)}`,
        `LOCATION:${evt.location||''}`,
        `DESCRIPTION:${(evt.notes||'').replace(/\n/g,'\\n')}`,
        'END:VEVENT','END:VCALENDAR'
      ].join('\r\n');
      return URL.createObjectURL(new Blob([lines], {type:'text/calendar'}));
    }

    // ---------- Render ----------
    function renderDOW(){
      dowEl.innerHTML=''; DOW.forEach(d=>{ const div=document.createElement('div'); div.className='dow'; div.textContent=d; dowEl.appendChild(div); });
    }
    function renderMonth(allEvents, y, m){
      gridEl.innerHTML='';
      const first = startOfMonth(y,m);
      const firstParts = partsInTZ(first);
      const totalDays = daysInMonth(y,m);
      monthlabel.textContent = fmtMonth.format(first);

      const leading = (firstParts.weekday + 7) % 7;
      const totalCells = Math.ceil((leading + totalDays)/7)*7;

      for(let i=0;i<totalCells;i++){
        const dayNum = i - leading + 1;
        const inMonth = dayNum>=1 && dayNum<=totalDays;
        const cell = document.createElement('div');
        cell.className='cell' + (inMonth?'':' other');

        const dateTop = document.createElement('div');
        dateTop.className='date';
        dateTop.textContent = inMonth ? String(dayNum) : ' ';
        cell.appendChild(dateTop);

        if (inMonth){
          const occ = allEvents.filter(e=>{
            const p=partsInTZ(e.start);
            return p.year===y && p.monthIndex===m && p.day===dayNum;
          }).sort((a,b)=>a.start-b.start);

          occ.forEach(evt=>{
            const ev = document.createElement('div');
            ev.className='ev' + (evt.title.startsWith('Holiday â€”')?' holiday':'');
            const t = document.createElement('time'); t.textContent = fmtTime.format(evt.start);
            const title = document.createElement('span'); title.className='t'; title.textContent = evt.title;
            const ics = document.createElement('a'); ics.href = makeICS(evt); ics.className='ics'; ics.download = `${evt.title.replace(/\s+/g,'_')}.ics`; ics.textContent='Add to Calendar'; ics.setAttribute('aria-label', `Add ${evt.title} to your calendar`);
            ev.appendChild(t); ev.appendChild(title); ev.appendChild(ics); cell.appendChild(ev);
          });
        }
        gridEl.appendChild(cell);
      }
    }
    function renderUpcoming(events, fromDate){
      const out = events.filter(e=>e.start>=fromDate).sort((a,b)=>a.start-b.start).slice(0,10);
      upcomingEl.innerHTML='';
      out.forEach(evt=>{
        const li=document.createElement('li');
        const when = `${fmtMonth.format(evt.start).split(' ')[0]} ${fmtDayNum.format(evt.start)} Â· ${fmtTime.format(evt.start)}`;
        li.innerHTML = `<strong>${evt.title}</strong> â€” ${when}${evt.location?` â€” <em>${evt.location}</em>`:''} &nbsp; <a class="ics" href="${makeICS(evt)}" download="${evt.title.replace(/\s+/g,'_')}.ics">Add to Calendar</a>`;
        upcomingEl.appendChild(li);
      });
    }

    // ---------- Data load & routing ----------
    window.RAW = null;
    async function loadEvents(){
      errEl.hidden = true;
      const res = await fetch(EVENTS_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('Net error');
      const data = await res.json();
      if (!data || !Array.isArray(data.events)) throw new Error('Bad JSON');
      window.RAW = data;
      return data;
    }
    function parseHash(){
      const m = (location.hash||'').match(/#\/(\d{4})\/(\d{2})/);
      if (m) return {year:+m[1], month:+m[2]-1};
      const now = new Date(); const p = partsInTZ(now);
      return {year:p.year, month:p.monthIndex};
    }
    function setHash(y,m){ const mm=String(m+1).padStart(2,'0'); location.hash = `#/${y}/${mm}`; }
    function expandAllFor(y,m){
      const acc=[]; (RAW.events||[]).forEach(ev=>expandEventForMonth(ev, y, m).forEach(x=>acc.push(x)));
      // holidays added via wrapper above
      return expandAllForMonth(y,m); // use wrapper
    }
    async function refresh(){
      const {year, month} = parseHash();
      renderDOW();
      const evts = expandAllFor(year, month);
      renderMonth(evts, year, month);
      // upcoming: this month + next 3
      const today = new Date();
      const look=[]; for(let i=0;i<4;i++){ const y2=year+Math.floor((month+i)/12); const m2=(month+i+12)%12; look.push(...expandAllFor(y2,m2)); }
      renderUpcoming(look, today);
      app.hidden=false;
    }

    // ---------- Events ----------
    document.getElementById('btn-print').addEventListener('click', ()=>window.print());
    document.getElementById('btn-today').addEventListener('click', ()=>{ const p=partsInTZ(new Date()); setHash(p.year,p.monthIndex); });
    document.getElementById('prev').addEventListener('click', ()=>{ const {year,month}=parseHash(); const m=(month+11)%12, y=year+(month===0?-1:0); setHash(y,m); });
    document.getElementById('next').addEventListener('click', ()=>{ const {year,month}=parseHash(); const m=(month+1)%12, y=year+(month===11?1:0); setHash(y,m); });
    document.getElementById('retry').addEventListener('click', ()=>{ loadEvents().then(refresh).catch(()=>{ errEl.hidden=false; }); });
    window.addEventListener('hashchange', refresh);

    // ---------- Boot ----------
    loadEvents()
      .then(()=>{ if(!location.hash){ const p=partsInTZ(new Date()); setHash(p.year,p.monthIndex); } else { refresh(); } })
      .catch(()=>{ errEl.hidden=false; app.hidden=false; });
  })();
  </script>
</body>
</html>

 
