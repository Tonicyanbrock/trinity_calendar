<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trinity Church Calendar of Events</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --panel:#ffffff; --ink:#0b1220; --muted:#475569;
      --accent:#16a34a; --accent-2:#2563eb;
      --grid:#cbd5e1; --tint:#f8fafc;
    }
    body {
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink);
      background:var(--tint);
    }
    header {
      background:rgba(22, 163, 74, 0.85);
      color:#fff;
      padding:1rem;
      text-align:center;
      font-size:1.5rem;
      font-weight:bold;
    }
    .banner img {
      width:100%;
      display:block;
    }
    #calendar {
      max-width:1000px;
      margin:1rem auto;
      padding:1rem;
      background:var(--panel);
      border-radius:1rem;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);

      /* watermark */
      background-image: url('assets/trinity-shield.png');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 80%;
      opacity: 0.95;
    }
    #calendar table {width:100%;border-collapse:collapse;}
    #calendar th,#calendar td {
      border:1px solid var(--grid);
      text-align:center;
      vertical-align:top;
      padding:.25rem;
      min-height:5rem;
    }
    #calendar th {background:var(--tint);}
    .event {
      margin:.15rem 0;
      padding:.15rem .3rem;
      border-radius:.5rem;
      font-size:.75rem;
    }
    .svc {background:#e0f2fe;color:#0369a1;}
    .aa {background:#fef9c3;color:#92400e;}
    .na {background:#fce7f3;color:#9d174d;}
    .holy {background:#dcfce7;color:#166534;}
    .diocesan {background:#e0e7ff;color:#1e3a8a;}
    .liturgical {
      display:inline-block;
      margin-left:.5rem;
      padding:.1rem .5rem;
      border-radius:.5rem;
      font-size:.8rem;
      color:#fff;
    }
    .nav {
      display:flex;
      justify-content:center;
      gap:.5rem;
      margin:1rem;
    }
    .nav button {
      background:var(--accent);
      color:#fff;
      border:none;
      padding:.5rem 1rem;
      border-radius:.5rem;
      cursor:pointer;
      font-weight:bold;
    }
    .nav button:hover {background:#15803d;}
    #upcoming {
      max-width:1000px;
      margin:1rem auto;
      padding:1rem;
    }
    .debug {
      max-width:1000px;
      margin:0 auto 2rem auto;
      color:var(--muted);
      font-size:.8rem;
    }
    footer {
      text-align:center;
      margin: 3rem 0 1.5rem 0;
    }
    footer a {
      display:inline-block;
      padding: 1rem 2rem;
      background-color: #9ec9f2;
      color: #0b1220;
      font-size: 1.25rem;
      border-radius: 0.75rem;
      text-decoration: none;
      font-weight: 600;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      transition: background-color 0.2s ease;
    }
    footer a:hover {
      background-color:#7fb6eb;
    }
  </style>
</head>
<body>
  <div class="banner">
    <img src="assets/trinity_calendar_banner.png?v=1" alt="Trinity Calendar of Events Banner">
  </div>

  <header>Trinity Church Calendar of Events</header>

  <div class="nav">
    <button onclick="changeMonth(-1)">â—€ Prev</button>
    <button onclick="goToday()">Today</button>
    <button onclick="changeMonth(1)">Next â–¶</button>
    <button onclick="window.print()">Print</button>
  </div>

  <div id="calendar"></div>

  <div id="upcoming">
    <h2>Upcoming Events</h2>
    <ul id="upcoming-list"></ul>
  </div>

  <div class="debug" id="debug"></div>

<script>
const ASSETS_VERSION = 349;  // bump this if updates donâ€™t show
const EVENTS_URLS = [
  `/assets/events.json?v=${ASSETS_VERSION}`,
  `/assets/liturgical.json?v=${ASSETS_VERSION}`,
  `/assets/diocesan.json?v=${ASSETS_VERSION}`
];

let events = [];
let liturgical = [];
let currentDate = new Date();

async function loadEvents() {
  for (const url of EVENTS_URLS) {
    try {
      const r = await fetch(url);
      if (!r.ok) throw new Error("HTTP " + r.status);
      if (url.includes("liturgical")) {
        liturgical = await r.json();
      } else {
        const more = await r.json();
        events = events.concat(more);
      }
    } catch (e) {
      console.error("Failed to load", url, e);
    }
  }
  renderCalendar(currentDate);
}

function changeMonth(offset) {
  currentDate.setMonth(currentDate.getMonth() + offset);
  renderCalendar(currentDate);
}

function goToday() {
  currentDate = new Date();
  renderCalendar(currentDate);
}

function renderCalendar(date) {
  const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
  const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);
  const weeks = [];
  let current = new Date(monthStart);
  current.setDate(current.getDate() - current.getDay());

  while (current <= monthEnd || current.getDay() !== 0) {
    const week = [];
    for (let d = 0; d < 7; d++) {
      week.push(new Date(current));
      current.setDate(current.getDate() + 1);
    }
    weeks.push(week);
  }

  const lit = liturgical.find(l => new Date(l.start) <= monthEnd && new Date(l.end) >= monthStart);
  const litChip = lit ? `<span class="liturgical" style="background:${lit.color}">${lit.name}</span>` : "";

  let html = `<h2>${monthStart.toLocaleString('default',{month:'long'})} ${monthStart.getFullYear()} ${litChip}</h2>`;
  html += `<table><thead><tr>`;
  ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(d => html += `<th>${d}</th>`);
  html += `</tr></thead><tbody>`;
  for (const week of weeks) {
    html += `<tr>`;
    for (const day of week) {
      const inMonth = day.getMonth() === monthStart.getMonth();
      html += `<td${inMonth?"":' style="background:#f1f5f9"'}>`;
      if (inMonth) {
        html += `<div>${day.getDate()}</div>`;
        const dayEvents = events.filter(ev => occursOn(ev, day));
        for (const ev of dayEvents) {
          let label = ev.type === "diocesan" ? " <span style='font-size:0.7em;color:#1e3a8a'>(Diocesan)</span>" : "";
          html += `<div class="event ${ev.type||''}">
                     ${ev.title}${label}
                     ${ev.location ? `<div style="font-size:0.7em;color:var(--muted)">${ev.location}</div>` : ""}
                   </div>`;
        }
      }
      html += `</td>`;
    }
    html += `</tr>`;
  }
  html += `</tbody></table>`;
  document.getElementById("calendar").innerHTML = html;

  const upcoming = [];
  const today = new Date();
  for (let i = 0; i < 30; i++) {
    const day = new Date(today);
    day.setDate(today.getDate() + i);
    const dayEvents = events.filter(ev => occursOn(ev, day));
    for (const ev of dayEvents) {
      upcoming.push(`${day.toLocaleDateString()} â€” ${ev.title}${ev.location ? " ("+ev.location+")" : ""}`);
    }
  }
  document.getElementById("upcoming-list").innerHTML = upcoming.map(e => `<li>${e}</li>`).join("");
}

function occursOn(ev, day) {
  const d = day.toISOString().split("T")[0];
  if (ev.start) {
    const evDate = ev.start.split("T")[0];
    return evDate === d;
  }
  if (ev.rrule) {
    return matchesRRule(ev.rrule, day);
  }
  return false;
}

function matchesRRule(rrule, day) {
  const [freqPart,...rest] = rrule.split(";");
  const freq = freqPart.split("=")[1];
  const dayStr = ["SU","MO","TU","WE","TH","FR","SA"][day.getDay()];
  if (freq==="WEEKLY" && rest.some(p=>p.includes("BYDAY="+dayStr))) return true;
  if (freq==="MONTHLY" && rest.some(p=>p.includes("BYDAY="+dayStr)) && rest.some(p=>p.includes("BYSETPOS=1")) && day.getDate()<=7) return true;
  return false;
}

loadEvents();
</script>

 <footer>
  <a href="https://www.diocesemo.org/calendar" target="_blank">
    ðŸ“… View Full Diocesan Calendar
  </a>
</footer>


</body>
</html>
