<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trinity Episcopal Church — Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family: ui-sans-serif, system-ui; background:#f8fafc; color:#111; }
    header { background:#e11d48 url('assets/stained-glass.jpg') center/cover no-repeat; padding:2rem; text-align:center; color:white; font-size:1.75rem; font-weight:bold; text-shadow:0 2px 4px rgba(0,0,0,0.6);}
    #calendar { padding:1rem; max-width:980px; margin:0 auto; }
    .month-label { display:flex; justify-content:center; align-items:center; gap:.5rem; font-size:1.5rem; font-weight:bold; margin:1rem 0; }
    .badge { padding:.2rem .6rem; border-radius:.5rem; font-size:.8rem; color:white; }
    .purple{background:#6b21a8}.green{background:#15803d}.red{background:#dc2626}.white{background:#f9fafb;color:#111}
    table{border-collapse:collapse;width:100%;}
    th,td{border:1px solid #cbd5e1;vertical-align:top;padding:.25rem;min-width:6rem;height:5rem;}
    td .daynum{font-weight:bold;margin-bottom:.25rem;}
    .today{background:#2563eb;color:white;}
    ul{list-style:none;margin:0;padding:0;}
    li{font-size:.75rem;margin:.15rem 0;}
    .upcoming{max-width:980px;margin:1rem auto;padding:1rem;}
    .debug{font-size:.75rem;color:#475569;margin:1rem auto;max-width:980px;}
  </style>
</head>
<body>
  <header>Trinity Church Calendar of Events</header>
  <div id="calendar"></div>
  <div class="upcoming">
    <h3>Upcoming Events</h3>
    <ul id="upcoming-list"></ul>
  </div>
  <div class="debug" id="debug"></div>

<script>
const ASSETS_VERSION = 315;
const EVENTS_URLS = [
  'assets/events.json?v='+ASSETS_VERSION,
  'admin/events.json?v='+ASSETS_VERSION
];

// === Helpers ===
function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1);}
function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0);}
function formatDate(d){return d.toLocaleDateString("en-US",{month:"short",day:"numeric"});}

// === Liturgical season ===
function liturgicalSeason(date){
  const m=date.getMonth()+1, d=date.getDate();
  if((m===12&&d>=1)||(m<=1)) return {name:"Advent / Christmas",cls:"purple"};
  if(m===2||m===3) return {name:"Lent",cls:"purple"};
  if(m===4) return {name:"Easter",cls:"white"};
  if(m===5) return {name:"Pentecost",cls:"red"};
  if(m>=6&&m<=10) return {name:"Ordinary Time",cls:"green"};
  return {name:"Season",cls:"green"};
}

// === RRULE expansion ===
function expandRrule(ev,rangeStart,rangeEnd){
  if(!ev.rrule) return [];
  const rules={}; ev.rrule.split(";").forEach(p=>{let[k,v]=p.split("=");rules[k]=v});
  const freq=rules.FREQ; const hour=+rules.BYHOUR||0; const minute=+rules.BYMINUTE||0;
  let dates=[];
  if(freq==="WEEKLY"&&rules.BYDAY){
    const map={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6};
    const target=map[rules.BYDAY];
    let d=new Date(rangeStart); d.setDate(d.getDate()+((7+target-d.getDay())%7));
    while(d<=rangeEnd){dates.push(new Date(d.getFullYear(),d.getMonth(),d.getDate(),hour,minute));d.setDate(d.getDate()+7);}
  }
  if(freq==="MONTHLY"&&rules.BYDAY&&rules.BYSETPOS){
    const map={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6}; const target=map[rules.BYDAY]; const setpos=+rules.BYSETPOS;
    for(let m=rangeStart.getMonth();m<=rangeEnd.getMonth();m++){let count=0;
      for(let i=1;i<=31;i++){let test=new Date(rangeStart.getFullYear(),m,i);if(test.getMonth()!==m)break;
        if(test.getDay()===target){count++; if(count===setpos){dates.push(new Date(test.getFullYear(),test.getMonth(),test.getDate(),hour,minute));}}
      }
    }
  }
  return dates;
}

// === Render ===
function render(events){
  const today=new Date();
  const rangeStart=startOfMonth(today), rangeEnd=endOfMonth(today);
  let expanded=[];
  events.forEach(ev=>{
    if(ev.date){expanded.push(ev);}
    else if(ev.rrule){expandRrule(ev,rangeStart,rangeEnd).forEach(d=>expanded.push({...ev,date:d}));}
  });
  let grouped={}; expanded.forEach(ev=>{let k=ev.date.toDateString(); if(!grouped[k])grouped[k]=[]; grouped[k].push(ev);});

  const cal=document.getElementById("calendar");
  const season=liturgicalSeason(today);
  let html=`<div class="month-label">${today.toLocaleString("default",{month:"long"})} ${today.getFullYear()} <span class="badge ${season.cls}">${season.name}</span></div>`;
  html+="<table><tr>"+["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(d=>`<th>${d}</th>`).join("")+"</tr><tr>";
  let startDay=rangeStart.getDay();
  for(let i=0;i<startDay;i++) html+="<td></td>";
  for(let d=1;d<=rangeEnd.getDate();d++){
    let day=new Date(today.getFullYear(),today.getMonth(),d);
    let classes=day.toDateString()===today.toDateString()?"today":"";
    let evHere=grouped[day.toDateString()]||[];
    html+=`<td class="${classes}"><div class="daynum">${d}</div>`;
    if(evHere.length){html+="<ul>"+evHere.map(ev=>`<li>${ev.title}</li>`).join("")+"</ul>";}
    html+="</td>"; if((startDay+d)%7===0) html+="</tr><tr>";
  }
  html+="</tr></table>"; cal.innerHTML=html;

  // Upcoming
  let list=document.getElementById("upcoming-list");
  let upcoming=expanded.filter(e=>e.date>=today).sort((a,b)=>a.date-b.date).slice(0,10);
  list.innerHTML=upcoming.map(ev=>`<li>${formatDate(ev.date)} — ${ev.title}</li>`).join("");
  document.getElementById("debug").textContent=`✅ Events loaded (${expanded.length})`;
}

async function loadEvents(){
  for(const url of EVENTS_URLS){
    try{const r=await fetch(url,{cache:"no-store"}); if(r.ok){const data=await r.json(); render(data); return;}}
    catch(e){console.warn("Failed",url,e);}
  }
  document.getElementById("debug").textContent="⚠️ Could not load events";
}
loadEvents();
</script>
</body>
</html>
