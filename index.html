<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trinity Episcopal De Soto â€” Calendar</title>
  <meta name="description" content="Monthly events & services at Trinity Episcopal Church, De Soto, MO. All are welcome." />
  <link rel="canonical" href="https://tonicyanbrock.github.io/trinity_calendar/" />
  <meta name="theme-color" content="#0b1220" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Trinity Episcopal De Soto â€” Calendar" />
  <meta property="og:title" content="Trinity Episcopal De Soto â€” Calendar" />
  <meta property="og:description" content="Monthly events & services at Trinity Episcopal Church, De Soto, MO." />
  <meta property="og:image" content="assets/view-calendar.png?v=222" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Trinity Episcopal De Soto â€” Calendar" />
  <meta name="twitter:description" content="Monthly events & services at Trinity Episcopal Church, De Soto, MO." />
  <meta name="twitter:image" content="assets/view-calendar.png?v=222" />

  <style>
    :root{
      --bg:#0b1220;           /* deep navy */
      --panel:#ffffff;        /* cards */
      --ink:#0e1726;          /* text */
      --muted:#475569;        /* secondary text */
      --grid:#d1d5db;         /* calendar grid */
      --tint:#f8fafc;         /* soft bg */
      --accent:#2563eb;       /* button */
      --aa:#14532d;           /* AA badge */
      --na:#7c2d12;           /* NA badge */
      --svc:#334155;          /* Service badge */
      --holy:#854d0e;         /* Holy Day */
      --btn:#16a34a;          /* action */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--ink);background:#fff}

    /* Stained-glass banner (CSS-based so no image dependency) */
    .banner{
      background: radial-gradient(1200px 600px at 10% -20%, #1e3a8a 0%, transparent 65%),
                  radial-gradient(900px 500px at 90% -30%, #9333ea 0%, transparent 65%),
                  radial-gradient(800px 400px at 30% -40%, #22c55e 0%, transparent 65%),
                  linear-gradient(180deg, #0b1220, #0b1220 40%, #111827 100%);
      border-bottom: 6px solid #11182733;
      color:#e5e7eb;
    }
    .banner-inner{max-width:1000px;margin:0 auto;padding:22px 14px;display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
    .brand{display:flex;gap:12px;align-items:center}
    .brand h1{margin:0;font-size:clamp(20px,3.2vw,28px);font-weight:800;letter-spacing:0.2px}
    .brand p{margin:0;color:#cbd5e1}
    .share-art{display:flex;align-items:center;gap:10px}
    .share-art img{display:block;width:220px;height:auto;border-radius:16px;box-shadow:0 6px 30px #00000055}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;background:var(--btn);color:white;font-weight:700;cursor:pointer}
    .btn:focus{outline:2px solid #fff3}

    /* App */
    .app{max-width:1000px;margin:14px auto;padding:12px}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .toolbar .spacer{flex:1}
    .monthbar{display:flex;gap:8px;align-items:center}
    .monthlabel{font-weight:800}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:#eee;color:#333}
    .liturgical{font-weight:700}

    /* Calendar grid */
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dow{font-size:12px;color:#334155;text-transform:uppercase;letter-spacing:1px}
    .cell{background:var(--panel);border:1px solid var(--grid);border-radius:12px;min-height:110px;padding:8px;display:flex;flex-direction:column;gap:6px}
    .cell .date{font-size:12px;color:#64748b;font-weight:700}
    .event{font-size:13px;line-height:1.3;border-left:4px solid transparent;padding-left:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:800;padding:2px 8px;border-radius:999px;color:#fff;margin-right:6px}
    .badge.aa{background:linear-gradient(0deg,#10b981,#059669);border-left-color:#059669}
    .badge.na{background:linear-gradient(0deg,#f97316,#ea580c);border-left-color:#ea580c}
    .badge.svc{background:linear-gradient(0deg,#64748b,#475569);border-left-color:#475569}
    .badge.holy{background:linear-gradient(0deg,#f59e0b,#d97706);border-left-color:#d97706}
    .event.aa{border-left-color:#059669}
    .event.na{border-left-color:#ea580c}
    .event.svc{border-left-color:#475569}
    .event.holy{border-left-color:#d97706}

    .aside{margin-top:18px;display:grid;grid-template-columns:1fr 320px;gap:14px}
    .card{background:var(--panel);border:1px solid var(--grid);border-radius:14px;padding:12px}
    .card h3{margin:6px 0 10px 0}
    .up-list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .up-item{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
    .up-date{font-size:12px;color:#475569;font-weight:700;width:92px}

    .legend{display:flex;flex-wrap:wrap;gap:8px}
    .legend .badge{margin:0}

    /* Print */
    @media print{
      .banner,.share-art,.toolbar .btn{display:none!important}
      .app{max-width:100%;padding:0}
      .card{break-inside:avoid}
    }

    /* Tiny helper */
    details.debug{margin-top:8px}
    details.debug summary{cursor:pointer;color:#0ea5e9}
    .muted{color:#64748b}
  </style>
</head>
<body>
  <header class="banner">
    <div class="banner-inner">
      <div class="brand">
        <div>
          <h1>Trinity Episcopal De Soto â€” Calendar</h1>
          <p>Monthly events & services at Trinity Episcopal Church, De Soto, MO. All are welcome.</p>
        </div>
      </div>
      <div class="share-art" style="justify-content:center;gap:16px">
        <!-- Centered image-as-button -->
        <a href="#app" id="viewLink" title="View Calendar">
          <img src="assets/view-calendar.png?v=223" alt="View Calendar"
               style="display:block;width:280px;max-width:40vw;height:auto;border-radius:16px;box-shadow:0 6px 30px #00000055" />
        </a>
        <button class="btn" id="printBtn">ðŸ–¨ Print Calendar</button>
      </div>
    </div>
  </header>

  <main class="app" id="app" hidden>
    <div class="toolbar">
      <button class="btn" id="prevMonth">â—€</button>
      <div class="monthbar">
        <div class="monthlabel" id="monthLabel">Month YYYY</div>
        <span class="chip liturgical" id="seasonChip">Ordinary Time</span>
      </div>
      <button class="btn" id="nextMonth">â–¶</button>
      <div class="spacer"></div>
      <button class="btn" id="todayBtn">Today</button>
    </div>

    <div class="grid" id="dow"></div>
    <div class="grid" id="calendar"></div>

    <div class="aside">
      <section class="card">
        <h3>Upcoming (next 10)</h3>
        <ul class="up-list" id="upcoming"></ul>
      </section>
      <section class="card">
        <h3>Legend</h3>
        <div class="legend">
          <span class="badge aa">AA 148 / 147</span>
          <span class="badge na">NA</span>
          <span class="badge svc">Sunday Service</span>
          <span class="badge holy">Holy Day</span>
        </div>
        <p class="muted" style="margin-top:10px">Trinity Episcopal Church, 202 W. Miller St., De Soto, MO 63020 â€¢ (636) 586â€‘2542</p>
      </section>
    </div>

    <details class="debug" id="debug">
      <summary>Debug info</summary>
      <pre id="dbg"></pre>
    </details>
  </main>

  <script>
  // ---------- CONFIG
  const ASSETS_VERSION = 223; // bump when assets/events.json changes
  const EVENTS_URLS = [ `assets/events.json?v=${ASSETS_VERSION}` ];
  let TZ = 'America/Chicago';

  // ---------- STATE
  let rawEvents = [];   // from JSON (supports rrule OR start)
  let allEvents = [];   // expanded instances for current view
  let current = new Date();
  const $ = sel => document.querySelector(sel);

  // ---------- UTILITIES
  const fmtDate = (d, opts={}) => new Intl.DateTimeFormat('en-US', { timeZone: TZ, ...opts }).format(d);
  const ymd = d => fmtDate(d, { year:'numeric', month:'2-digit', day:'2-digit' }).split('/').reverse().join('-');
  const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
  const endOfMonth   = (d) => new Date(d.getFullYear(), d.getMonth()+1, 0);
  const addDays = (d, n) => new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);
  const setTimeLocal = (d,h=0,m=0) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0);

  function seasonFor(date){
    const m = date.getMonth()+1, day = date.getDate();
    if((m===12 && day>=1) || (m===1)) return {name:'Advent/Christmastide', color:'#6d28d9'};
    if(m===3 || m===4) return {name:'Lent/Easter', color:'#6d28d9'};
    if(m===5 || m===6) return {name:'Pentecost', color:'#ef4444'};
    return {name:'Ordinary Time', color:'#16a34a'};
  }

  // ---------- LOAD
  async function loadEvents(){
    const dbg = [];
    for(const url of EVENTS_URLS){
      try{
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        const data = await res.json();
        if(data.timezone) TZ = data.timezone;
        if(Array.isArray(data)) rawEvents.push(...data);
        else if(Array.isArray(data.events)) rawEvents.push(...data.events);
        else dbg.push(`WARN: ${url} had no array`);
        dbg.push(`OK: ${url} (raw count=${rawEvents.length})`);
      }catch(err){ dbg.push(`FAIL: ${url} â†’ ${err.message}`); }
    }
    $('#dbg').textContent = dbg.join('
');
  }

  // ---------- RRULES (WEEKLY + MONTHLY BYDAY/BYSETPOS with BYHOUR/BYMINUTE)
  const DOW = {SU:0, MO:1, TU:2, WE:3, TH:4, FR:5, SA:6};
  function parseRRule(rr=''){
    const out = {freq:null, byday:[], bysetpos:null, byhour:0, byminute:0};
    rr.split(';').forEach(part=>{
      const [k,v] = part.split('=');
      if(!k||!v) return;
      const K = k.toUpperCase();
      if(K==='FREQ') out.freq = v.toUpperCase();
      if(K==='BYDAY') out.byday = v.split(',').map(s=>s.trim().toUpperCase());
      if(K==='BYSETPOS') out.bysetpos = parseInt(v,10);
      if(K==='BYHOUR') out.byhour = parseInt(v,10)||0;
      if(K==='BYMINUTE') out.byminute = parseInt(v,10)||0;
    });
    return out;
  }
  function nthDowOfMonth(y,m,dow,setpos){
    if(setpos===-1){
      const last = new Date(y, m+1, 0);
      const delta = (last.getDay() - dow + 7) % 7;
      return addDays(last, -delta);
    }
    const first = new Date(y, m, 1);
    const offset = (dow - first.getDay() + 7) % 7;
    const day = 1 + offset + (setpos-1)*7;
    return new Date(y, m, day);
  }

  function tagFromTitle(t=''){
    const s = t.toLowerCase();
    if(s.includes('aa')) return 'aa';
    if(s.includes('narcotics') || s.includes(' na') || s==='na') return 'na';
    if(s.includes('service') || s.includes('eucharist') || s.includes('mass')) return 'svc';
    if(s.includes('ash wednesday') || s.includes('pentecost') || s.includes('holy') || s.includes('easter') || s.includes('advent')) return 'holy';
    return 'other';
  }

  function wireToEvent(e){
    return {
      id: e.id || undefined,
      title: e.title,
      notes: e.notes || '',
      where: e.location || e.where || 'Trinity Episcopal Church',
      start: e.start || null,
      end: e.end || null,
      rrule: e.rrule || null,
      duration_minutes: e.duration_minutes || null,
      type: (e.type || tagFromTitle(e.title)).toLowerCase(),
    };
  }

  function instanceFrom(r, dt){
    return {
      id: r.id || `${r.title}|${dt.toISOString()}`,
      title: r.title,
      where: r.where,
      start: dt.toISOString(),
      end: r.end || null,
      type: r.type,
    };
  }

  function expandEventsInRange(raw, fromDate, toDate){
    const out = [];
    const from = new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate());
    const to = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate(), 23,59,59);

    for(const r of raw.map(wireToEvent)){
      if(r.rrule){
        const rule = parseRRule(r.rrule);
        if(rule.freq==='WEEKLY' && rule.byday.length){
          for(let d=new Date(from); d<=to; d=addDays(d,1)){
            const code = Object.keys(DOW).find(k=>DOW[k]===d.getDay());
            if(rule.byday.includes(code)){
              const dt = setTimeLocal(d, rule.byhour, rule.byminute);
              out.push(instanceFrom(r, dt));
            }
          }
        } else if(rule.freq==='MONTHLY' && rule.byday.length && r.rrule.includes('BYSETPOS')){
          for(let y=from.getFullYear(); y<=to.getFullYear(); y++){
            const mStart = (y===from.getFullYear()? from.getMonth():0);
            const mEnd = (y===to.getFullYear()? to.getMonth():11);
            for(let m=mStart; m<=mEnd; m++){
              for(const code of rule.byday){
                const dow = DOW[code];
                const occ = nthDowOfMonth(y, m, dow, rule.bysetpos||1);
                if(occ>=from && occ<=to){
                  const dt = setTimeLocal(occ, rule.byhour, rule.byminute);
                  out.push(instanceFrom(r, dt));
                }
              }
            }
          }
        }
      } else if(r.start){
        const dt = new Date(r.start);
        if(dt>=from && dt<=to) out.push(instanceFrom(r, dt));
      }
    }
    const seen = new Set();
    return out.filter(e=>{ const key = `${e.title}|${e.start}`; if(seen.has(key)) return false; seen.add(key); return true; });
  }

  // ---------- RENDER
  function render(){
    const dowNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    $('#dow').innerHTML = dowNames.map(d=>`<div class="dow">${d}</div>`).join('');

    const a = startOfMonth(current);
    const firstCell = addDays(a, -a.getDay());
    const cells = [];
    for(let i=0;i<42;i++) cells.push(addDays(firstCell, i));

    // Label & season chip
    $('#monthLabel').textContent = fmtDate(current, { month:'long', year:'numeric'});
    const season = seasonFor(current);
    const chip = $('#seasonChip');
    chip.textContent = season.name; chip.style.background = season.color; chip.style.color = '#fff';

    // Expand raw events to visible window
    const rangeStart = cells[0];
    const rangeEnd = cells[cells.length-1];
    allEvents = expandEventsInRange(rawEvents, rangeStart, rangeEnd);

    // Group by day
    const byDay = new Map();
    for(const e of allEvents.map(e=>({...e, d:new Date(e.start)})).sort((a,b)=> a.d-b.d || a.title.localeCompare(b.title))){
      const k = ymd(e.d);
      if(!byDay.has(k)) byDay.set(k, []);
      byDay.get(k).push(e);
    }

    $('#calendar').innerHTML = cells.map(d => {
      const k = ymd(d);
      const inMonth = d.getMonth()===current.getMonth();
      const list = (byDay.get(k)||[]).map(renderEvent).join('');
      return `<div class="cell" style="opacity:${inMonth?1:0.48}">
        <div class="date">${fmtDate(d,{day:'numeric'})}</div>
        ${list||''}
      </div>`;
    }).join('');

    // Upcoming (next 10) from today forward
    const today = new Date();
    const future = expandEventsInRange(rawEvents, today, addDays(today, 180));
    const next10 = future.sort((a,b)=> new Date(a.start)-new Date(b.start)).slice(0,10);
    $('#upcoming').innerHTML = next10.map(e=>`
      <li class="up-item">
        <div class="up-date">${fmtDate(new Date(e.start), { weekday:'short', month:'short', day:'numeric'})}</div>
        <div><span class="badge ${e.type}">${badgeText(e)}</span> ${escapeHtml(e.title)}</div>
      </li>`).join('');

    $('#app').hidden = false;
  }

  function renderEvent(e){
    const cls = `event ${e.type}`;
    return `<div class="${cls}"><span class="badge ${e.type}">${badgeText(e)}</span> ${escapeHtml(e.title)}</div>`;
  }
  function badgeText(e){
    if(e.type==='aa') return 'AA';
    if(e.type==='na') return 'NA';
    if(e.type==='svc') return 'Service';
    if(e.type==='holy') return 'Holy Day';
    return 'Event';
  }
  function escapeHtml(s=''){return s.replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}

  // ---------- NAV
  $('#prevMonth').addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()-1, 1); render(); window.scrollTo({top:document.querySelector('.app').offsetTop-10, behavior:'smooth'}); });
  $('#nextMonth').addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()+1, 1); render(); window.scrollTo({top:document.querySelector('.app').offsetTop-10, behavior:'smooth'}); });
  $('#todayBtn').addEventListener('click', ()=>{ current = new Date(); render(); window.scrollTo({top:document.querySelector('.app').offsetTop-10, behavior:'smooth'}); });
  $('#printBtn').addEventListener('click', ()=> window.print());
  const goToCalendar = ()=>{
    const el = document.getElementById('app');
    el.hidden = false; // reveal if hidden
    // ensure first render happened
    if(!el.dataset.rendered){ render(); el.dataset.rendered = '1'; }
    const y = document.querySelector('.app').offsetTop - 10;
    window.scrollTo({ top: y, behavior: 'smooth' });
  };
  document.getElementById('viewLink').addEventListener('click', (e)=>{ e.preventDefault(); goToCalendar(); });

  // ---------- BOOT
  (async function(){
    $('#dow').innerHTML = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="dow">${d}</div>`).join('');
    await loadEvents();

    // Guardrails to avoid duplicates:
    // 1) Only /assets/events.json exists (no stray root events.json)
    // 2) Single entry in EVENTS_URLS
    // 3) Bump ASSETS_VERSION after changing events.json

    render();
  })();
  </script>
</body>
</html>
