<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trinity Episcopal De Soto — Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --panel:#ffffff; --ink:#0b1220; --muted:#475569;
      --accent:#16a34a; --accent-2:#2563eb;
      --grid:#64748b; --tint:#f8fafc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--ink);background:#fff}
    .app{max-width:980px;margin:14px auto;padding:12px}
    .header{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
    h1{margin:0;font-size:1.5rem;font-weight:600;text-align:center}
    .btn{background:#16a34a;color:white;padding:6px 14px;border-radius:8px;border:none;cursor:pointer;font-size:14px}
    .btn:hover{background:#15803d}
    .tag{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:500;margin-left:6px}
    .tag.ordinary{background:#16a34a;color:#fff}
    .legend{margin-top:20px;padding:10px;border:1px solid var(--grid);border-radius:8px;background:var(--tint)}
    .legend span{display:inline-block;margin:4px;padding:2px 8px;border-radius:8px;font-size:12px;font-weight:500}
    .legend .aa{background:#22c55e;color:#fff}
    .legend .na{background:#f97316;color:#fff}
    .legend .svc{background:#475569;color:#fff}
    .legend .holy{background:#eab308;color:#fff}
    .debug{margin-top:20px;font-size:12px;color:#475569}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <button class="btn" data-btn="prev">◀</button>
      <h1>Trinity Episcopal De Soto — Calendar</h1>
      <button class="btn" data-btn="next">▶</button>
    </div>
    <div style="text-align:center;margin:10px 0;">
      <button class="btn" data-btn="today">Today</button>
      <button class="btn" onclick="window.print()">Print</button>
      <button class="btn" data-btn="hide">Hide</button>
    </div>
    <div id="calendar"></div>
    <div id="upcoming"></div>
    <div class="legend">
      <strong>Legend</strong><br>
      <span class="aa">AA 148 / 147</span>
      <span class="na">NA</span>
      <span class="svc">Sunday Service</span>
      <span class="holy">Holy Day</span>
      <div style="margin-top:6px;font-size:12px;">
        Trinity Episcopal Church, 202 W. Miller St., De Soto, MO 63020 • (636) 586-2542
      </div>
    </div>
    <div class="debug" id="debug"></div>
  </div>

<script>
const ASSETS_VERSION = 291;

const EVENTS_URLS = [
  'assets/events.json?v=' + ASSETS_VERSION,
  'admin/events.json?v=' + ASSETS_VERSION
];

const state = { year:0, month:0, events:[] };

async function loadEvents() {
  for (const url of EVENTS_URLS) {
    try {
      const r = await fetch(url, {cache:'no-store'});
      if (r.ok) return await r.json();
    } catch {}
  }
  throw new Error("Could not load events");
}

function startOfMonth(y,m){ return new Date(y,m,1);}
function endOfMonth(y,m){ return new Date(y,m+1,0);}
function pad(n){return String(n).padStart(2,'0');}
function fmtDate(d){return d.toLocaleDateString(undefined,{month:'short',day:'numeric'});}

function render(){
  const y = state.year, m = state.month;
  const cal = document.getElementById('calendar');
  const start = startOfMonth(y,m), end = endOfMonth(y,m);
  let html = `<h2>${start.toLocaleString('default',{month:'long'})} ${y}<span class="tag ordinary">Ordinary Time</span></h2>`;
  html += `<table style="width:100%;border-collapse:collapse;text-align:center"><tr>`;
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>html+=`<th>${d}</th>`);
  html += `</tr><tr>`;
  for(let i=0;i<start.getDay();i++) html+="<td></td>";
  let day=1;
  const daysInMonth=end.getDate();
  while(day<=daysInMonth){
    const dateStr=`${y}-${pad(m+1)}-${pad(day)}`;
    const todays=state.events.filter(ev=>(ev.start||ev.rrule)?.startsWith(dateStr));
    html+=`<td style="border:1px solid #ccc;vertical-align:top;height:80px"><div>${day}</div>`;
    todays.forEach(ev=>{
      html+=`<div style="font-size:12px;margin:2px;padding:2px;border-radius:4px;background:${
        ev.type==='aa'?'#22c55e':ev.type==='na'?'#f97316':ev.type==='svc'?'#475569':ev.type==='holy'?'#eab308':'#94a3b8'
      };color:#fff">${ev.title}</div>`;
    });
    html+="</td>";
    if((start.getDay()+day)%7===0) html+="</tr><tr>";
    day++;
  }
  html+="</tr></table>";
  cal.innerHTML=html;

  const upcoming = document.getElementById('upcoming');
  let upcomingList=state.events.slice(0,10).map(ev=>{
    return `<li>${fmtDate(new Date(ev.start))} — ${ev.title}</li>`;
  }).join('');
  upcoming.innerHTML=`<h3>Upcoming (next 10)</h3><ul>${upcomingList}</ul>`;
}

document.querySelector('[data-btn="prev"]').onclick=()=>{state.month--;if(state.month<0){state.month=11;state.year--;}render();}
document.querySelector('[data-btn="next"]').onclick=()=>{state.month++;if(state.month>11){state.month=0;state.year++;}render();}
document.querySelector('[data-btn="today"]').onclick=()=>{const now=new Date();state.year=now.getFullYear();state.month=now.getMonth();render();}
document.querySelector('[data-btn="hide"]').onclick=()=>{document.querySelector('.app').style.display='none';}

(async()=>{
  try {
    const ev=await loadEvents();
    state.events=ev;
    const now=new Date();state.year=now.getFullYear();state.month=now.getMonth();
    render();
    document.getElementById('debug').textContent=`OK: events loaded (${ev.length} total)`;
  } catch(e){
    document.getElementById('debug').textContent="⚠️ "+e.message;
  }
})();
</script>
</body>
</html>
