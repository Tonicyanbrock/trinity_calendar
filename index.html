<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trinity Episcopal De Soto ‚Äî Calendar</title>
  <meta name="description" content="Monthly events & services at Trinity Episcopal Church, De Soto, MO. All are welcome." />
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --panel:#ffffff; --ink:#0e1726; --muted:#475569;
      --grid:#e5e7eb; --accent:#2563eb; --btn:#16a34a; --google:#f97316;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--ink);background:#fff}

    /* Banner */
    .banner{
      background: radial-gradient(1200px 600px at 10% -20%, #1e3a8a 0%, transparent 65%),
                  radial-gradient(900px 500px at 90% -30%, #9333ea 0%, transparent 65%),
                  radial-gradient(800px 400px at 30% -40%, #22c55e 0%, transparent 65%),
                  linear-gradient(180deg, #0b1220, #0b1220 40%, #111827 100%);
      color:#e5e7eb; border-bottom:6px solid #11182733; text-align:center
    }
    .banner-inner{max-width:1000px;margin:0 auto;padding:32px 14px}
    .banner img{display:block;width:min(360px,45vw);height:auto;border-radius:16px;
      box-shadow:0 6px 30px #00000055;margin:0 auto 16px}
    h1{margin:0 0 6px 0;font-size:clamp(22px,4vw,32px);font-weight:800}

    /* App & controls */
    .app{max-width:1000px;margin:14px auto;padding:12px}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;background:var(--btn);color:white;font-weight:700;cursor:pointer}
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    .toolbar .spacer{flex:1}
    .monthbar{display:flex;gap:8px;align-items:center}
    .monthlabel{font-weight:800}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;background:#eee;color:#333;font-weight:700}

    /* Calendar grid */
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .dow{font-size:12px;color:#334155;text-transform:uppercase;letter-spacing:1px}
    .cell{background:#fff;border:1px solid var(--grid);border-radius:12px;min-height:110px;padding:8px;display:flex;flex-direction:column;gap:6px}
    .cell .date{font-size:12px;color:#64748b;font-weight:700}
    .event{font-size:13px;line-height:1.3;border-left:4px solid transparent;padding-left:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:800;padding:2px 8px;border-radius:999px;color:#fff;margin-right:6px}
    .badge.aa{background:linear-gradient(0deg,#10b981,#059669)} .event.aa{border-left-color:#059669}
    .badge.na{background:linear-gradient(0deg,#f97316,#ea580c)} .event.na{border-left-color:#ea580c}
    .badge.svc{background:linear-gradient(0deg,#64748b,#475569)} .event.svc{border-left-color:#475569}
    .badge.holy{background:linear-gradient(0deg,#f59e0b,#d97706)} .event.holy{border-left-color:#d97706}
    .aside{margin-top:18px;display:grid;grid-template-columns:1fr 320px;gap:14px}
    .card{background:#fff;border:1px solid var(--grid);border-radius:14px;padding:12px}
    .up-list{list-style:none;margin:0;padding:0;display:grid;gap:10px}
    .up-item{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
    .up-date{font-size:12px;color:#475569;font-weight:700;width:92px}

    /* Add-to-calendar mini button */
    .addbtn{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;
      border:1px solid var(--google);background:#fff;color:var(--google);text-decoration:none;margin-left:6px}
    .addbtn:hover{background:#fef3c7}

    /* Print */
    @media print{ .banner,.toolbar .btn{display:none!important}; .app{max-width:100%;padding:0} .card{break-inside:avoid} }

    /* Misc */
    details.debug{margin-top:8px} details.debug summary{cursor:pointer;color:#0ea5e9}
    .muted{color:#64748b}
  </style>
</head>
<body>
  <!-- Banner -->
  <header class="banner">
    <div class="banner-inner">
      <a href="#app" id="viewLink" title="View Calendar" style="text-decoration:none;color:inherit">
        <img src="assets/view-calendar.png" alt="View Calendar" onerror="this.style.display='none'">
        <h1>Trinity Episcopal De Soto ‚Äî Calendar</h1>
      </a>
    </div>
  </header>

  <!-- Calendar app -->
  <main class="app" id="app" hidden>
    <section class="card" style="margin-bottom:10px">
      <strong>Monthly events &amp; services at Trinity Episcopal Church, De Soto, MO. All are welcome.</strong>
    </section>

    <div class="toolbar">
      <button class="btn" id="prevMonth">‚óÄ</button>
      <div class="monthbar">
        <div class="monthlabel" id="monthLabel">Month YYYY</div>
        <span class="chip" id="seasonChip">Season</span>
      </div>
      <button class="btn" id="nextMonth">‚ñ∂</button>
      <div class="spacer"></div>
      <button class="btn" id="todayBtn">Today</button>
      <button class="btn" id="printBtn">üñ® Print</button>
      <button class="btn" id="hideBtn">Hide</button>
    </div>

    <div class="grid" id="dow"></div>
    <div class="grid" id="calendar"></div>

    <div class="aside">
      <section class="card">
        <h3>Upcoming (next 10)</h3>
        <ul class="up-list" id="upcoming"></ul>
      </section>
      <section class="card">
        <h3>Legend</h3>
        <div class="legend">
          <span class="badge aa">AA 148 / 147</span>
          <span class="badge na">NA</span>
          <span class="badge svc">Sunday Service</span>
          <span class="badge holy">Holy Day</span>
        </div>
        <p class="muted" style="margin-top:10px">Trinity Episcopal Church, 202 W. Miller St., De Soto, MO 63020 ‚Ä¢ (636) 586-2542</p>
      </section>
    </div>

    <details class="debug" id="debug">
      <summary>Debug info</summary>
      <pre id="dbg"></pre>
    </details>
  </main>

  <script>
 const ASSETS_VERSION = 271;
  const EVENTS_URLS = [ `assets/events.json?v=${ASSETS_VERSION}` ];
  const LITURGICAL_URL = `assets/liturgical.json?v=${ASSETS_VERSION}`;
  let TZ = 'America/Chicago';
  let rawEvents = [], allEvents = [], litSeasons = [];
  let current=new Date();

  // Utilities
  const fmtDate = (d, opts={}) => new Intl.DateTimeFormat('en-US', { timeZone: TZ, ...opts }).format(d);
  const ymd = d => fmtDate(d, { year:'numeric', month:'2-digit', day:'2-digit' }).split('/').reverse().join('-');
  const startOfMonth = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
  const addDays = (d, n) => new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);
  const setTimeLocal = (d,h=0,m=0) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), h, m, 0);

  // Load events + liturgical
  async function loadEvents(){
    const dbg = [], dbgEl=document.getElementById('dbg'), app=document.getElementById('app');
    for(const url of EVENTS_URLS){
      try{
        const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error(res.status+" "+res.statusText);
        const data=await res.json();
        if(data.timezone) TZ=data.timezone;
        if(Array.isArray(data)) rawEvents.push(...data);
        else if(Array.isArray(data.events)) rawEvents.push(...data.events);
        else dbg.push(`WARN: ${url} had no array`);
        dbg.push(`OK: ${url} (raw count=${rawEvents.length})`);
      }catch(err){
        dbg.push(`FAIL: ${url} ‚Üí ${err.message}`);
        app.innerHTML=`<div style="background:#fee2e2;color:#b91c1c;padding:16px;border-radius:8px;font-weight:bold;">‚ö†Ô∏è Could not load events: ${err.message}</div>`;
      }
    }
    try{
      const res=await fetch(LITURGICAL_URL,{cache:'no-store'});
      if(res.ok){ litSeasons=await res.json(); dbg.push(`OK: liturgical.json loaded (${litSeasons.length} entries)`); }
    }catch(e){ dbg.push("No liturgical.json found"); }
    dbgEl.textContent=dbg.join('\n');
  }

  // Season logic
  function seasonFor(date){
    if(litSeasons.length){
      const iso=date.toISOString().split('T')[0];
      const hit=litSeasons.find(s=>iso>=s.start&&iso<=s.end);
      if(hit) return {name:hit.name,color:hit.color};
    }
    const m=date.getMonth()+1,day=date.getDate();
    if((m===12&&day>=1)||(m===1)) return {name:'Advent/Christmastide',color:'#6d28d9'};
    if(m===3||m===4) return {name:'Lent/Easter',color:'#6d28d9'};
    if(m===5||m===6) return {name:'Pentecost',color:'#ef4444'};
    return {name:'Ordinary Time',color:'#16a34a'};
  }

  // RRULE + expandEventsInRange + helpers (same as your last working file) ...

  // Render function
  function render(){
    const dowNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    document.getElementById('dow').innerHTML=dowNames.map(d=>`<div class="dow">${d}</div>`).join('');
    const a=startOfMonth(current),firstCell=addDays(a,-a.getDay()),cells=[];
    for(let i=0;i<42;i++) cells.push(addDays(firstCell,i));
    document.getElementById('monthLabel').textContent=fmtDate(current,{month:'long',year:'numeric'});
    const season=seasonFor(current); const chip=document.getElementById('seasonChip');
    chip.textContent=season.name; chip.style.background=season.color; chip.style.color='#fff';
    // liturgical tint
    document.getElementById('calendar').style.background=season.color+"20";
    const rangeStart=cells[0],rangeEnd=cells[cells.length-1];
    allEvents=expandEventsInRange(rawEvents,rangeStart,rangeEnd);
    const byDay=new Map(); for(const e of allEvents.map(e=>({...e,d:new Date(e.start)})).sort((a,b)=>a.d-b.d||a.title.localeCompare(b.title))){const k=ymd(e.d);if(!byDay.has(k)) byDay.set(k,[]);byDay.get(k).push(e);}
    document.getElementById('calendar').innerHTML=cells.map(d=>{const k=ymd(d),inMonth=d.getMonth()===current.getMonth(),list=(byDay.get(k)||[]).map(renderEvent).join('');return `<div class="cell" style="opacity:${inMonth?1:0.48}"><div class="date">${fmtDate(d,{day:'numeric'})}</div>${list||''}</div>`;}).join('');
    const today=new Date(),future=expandEventsInRange(rawEvents,today,addDays(today,180)),next10=future.sort((a,b)=>new Date(a.start)-new Date(b.start)).slice(0,10);
    document.getElementById('upcoming').innerHTML=next10.map(e=>`<li class="up-item"><div class="up-date">${fmtDate(new Date(e.start),{weekday:'short',month:'short',day:'numeric'})}</div><div><span class="badge ${e.type}">${badgeText(e)}</span> ${escapeHtml(e.title)}<a class="addbtn" href="${gcalUrl(e)}" target="_blank">Add to Google</a></div></li>`).join('');
    document.getElementById('app').hidden=false;
  }

  // Button listeners
  document.getElementById('viewLink').addEventListener('click',e=>{e.preventDefault();goToCalendar();});
  document.getElementById('prevMonth').addEventListener('click',()=>{current=new Date(current.getFullYear(),current.getMonth()-1,1);render();goToCalendar();});
  document.getElementById('nextMonth').addEventListener('click',()=>{current=new Date(current.getFullYear(),current.getMonth()+1,1);render();goToCalendar();});
  document.getElementById('todayBtn').addEventListener('click',()=>{current=new Date();render();goToCalendar();const todayCell=[...document.querySelectorAll('.cell')].find(c=>c.querySelector('.date')?.textContent===String(new Date().getDate()));if(todayCell){todayCell.style.outline="3px solid #f97316";todayCell.scrollIntoView({behavior:"smooth",block:"center"});setTimeout(()=>todayCell.style.outline="",2000);}});
  document.getElementById('printBtn').addEventListener('click',()=>window.print());
  document.getElementById('hideBtn').addEventListener('click',()=>{document.getElementById('app').hidden=true;const link=document.getElementById('viewLink');link.style.boxShadow="0 0 12px 4px #16a34a";setTimeout(()=>link.style.boxShadow="",4000);window.scrollTo({top:0,behavior:'smooth'});});

  function goToCalendar(){const el=document.getElementById('app');el.hidden=false;render();const y=document.querySelector('.app').offsetTop-10;window.scrollTo({top:y,behavior:'smooth'});}

  (async function(){document.getElementById('dow').innerHTML=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=>`<div class="dow">${d}</div>`).join('');await loadEvents();render();})();
  </script>
</body>
</html>
