<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Trinity Episcopal De Soto — Calendar</title>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#fff;color:#0b1220}
  .app{max-width:900px;margin:24px auto;padding:16px}
  h1{margin:0 0 12px}
  .nav{display:flex;justify-content:space-between;align-items:center;margin:12px 0}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #cbd5e1;vertical-align:top;padding:6px;min-height:80px}
  th{background:#f1f5f9;text-align:center}
  .date{font-weight:bold;margin-bottom:4px}
  .event{margin:2px 0;font-size:14px}
  .btn{display:inline-block;margin-top:2px;font-size:12px;color:#2563eb;text-decoration:none}
</style>
</head>
<body>
<div class="app">
  <h1>Trinity Episcopal De Soto — Calendar</h1>
  <div class="nav">
    <button id="prev">◀</button>
    <div id="monthLabel"></div>
    <button id="next">▶</button>
  </div>
  <table id="calendar"></table>
</div>

<script>
const EVENTS_URL = "assets/events.json?v=" + Date.now();
let events = [];
let current = new Date();

function toKey(d){ return d.toISOString().split('T')[0]; }

function googleLink(ev){
  const start = new Date(ev.start);
  const end = new Date(start.getTime() + (ev.durationMinutes||60)*60000);
  const fmt = d => d.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}Z$/,"Z");
  const text = encodeURIComponent(ev.title);
  const dates = fmt(start) + "/" + fmt(end);
  const loc = encodeURIComponent(ev.location||"");
  const details = encodeURIComponent(ev.notes||"");
  return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&location=${loc}&details=${details}`;
}

function expand(evs){
  const out=[];
  const start=new Date(current.getFullYear(),current.getMonth(),1);
  const end=new Date(current.getFullYear(),current.getMonth()+1,0,23,59,59);
  for(const ev of evs){
    if(ev.start){
      const when=new Date(ev.start);
      if(when>=start && when<=end) out.push(ev);
      continue;
    }
    if(ev.recurrence && ev.recurrence.rrule && ev.recurrence.dtstart){
      const dt0=new Date(ev.recurrence.dtstart);
      if(ev.recurrence.rrule.startsWith("FREQ=WEEKLY")){
        const byday=(ev.recurrence.rrule.match(/BYDAY=([A-Z,]+)/)||[])[1]||"";
        const want=new Set(byday.split(","));
        for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){
          const wk=['SU','MO','TU','WE','TH','FR','SA'][d.getDay()];
          if(d>=dt0 && want.has(wk)){
            const s=new Date(d); s.setHours(dt0.getHours(),dt0.getMinutes(),0,0);
            out.push({...ev,start:s.toISOString()});
          }
        }
      } else if(ev.recurrence.rrule.startsWith("FREQ=MONTHLY")){
        const bysetpos=(ev.recurrence.rrule.match(/BYSETPOS=(\-?\d+)/)||[])[1];
        const byday=(ev.recurrence.rrule.match(/BYDAY=([A-Z]{2})/)||[])[1];
        if(bysetpos==="1" && byday==="SU"){
          const first=new Date(current.getFullYear(),current.getMonth(),1);
          const add=(7-first.getDay())%7;
          const day=new Date(first); day.setDate(first.getDate()+add);
          if(day>=dt0 && day<=end){
            const s=new Date(day); s.setHours(dt0.getHours(),dt0.getMinutes(),0,0);
            out.push({...ev,start:s.toISOString()});
          }
        }
      }
    }
  }
  return out;
}

function render(){
  const year=current.getFullYear(),month=current.getMonth();
  const first=new Date(year,month,1);
  const last=new Date(year,month+1,0);
  const weeks=[];
  let week=new Array(7).fill(null);
  let day=1, dow=first.getDay();

  for(let i=0;i<dow;i++) week[i]=null;
  while(day<=last.getDate()){
    week[dow]={y:year,m:month,d:day};
    dow++;
    if(dow===7){ weeks.push(week); week=new Array(7).fill(null); dow=0; }
    day++;
  }
  if(dow>0) weeks.push(week);

  const monthLabel=new Intl.DateTimeFormat("en",{month:"long",year:"numeric"}).format(first);
  document.getElementById("monthLabel").textContent=monthLabel;

  const expanded=expand(events);
  const grouped={};
  for(const ev of expanded){
    const key=toKey(new Date(ev.start));
    (grouped[key]=grouped[key]||[]).push(ev);
  }

  const $cal=document.getElementById("calendar");
  $cal.innerHTML="<tr>"+["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(d=>`<th>${d}</th>`).join("")+"</tr>";
  for(const w of weeks){
    $cal.innerHTML+="<tr>"+w.map(cell=>{
      if(!cell) return "<td></td>";
      const date=new Date(cell.y,cell.m,cell.d);
      const key=toKey(date);
      const evs=grouped[key]||[];
      return `<td><div class="date">${cell.d}</div>`+
        evs.map(e=>`<div class="event">${e.title}<br><a class="btn" href="${googleLink(e)}" target="_blank">Add</a></div>`).join("")+
        "</td>";
    }).join("")+"</tr>";
  }
}

async function load(){
  const res=await fetch(EVENTS_URL);
  events=await res.json();
  render();
}
document.getElementById("prev").onclick=()=>{current.setMonth(current.getMonth()-1);render();}
document.getElementById("next").onclick=()=>{current.setMonth(current.getMonth()+1);render();}
load();
</script>
</body>
</html>

