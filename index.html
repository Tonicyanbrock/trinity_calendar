   <!-- Calendar logic -->
<script>
  const grid=document.getElementById("grid");
  const monthLabel=document.getElementById("monthLabel");
  let current=new Date();

  // Load one-off (manual) events from localStorage (kept exactly like your version)
  let events=JSON.parse(localStorage.getItem("churchEvents")||"[]");

  // Controls & fields
  const prev=document.getElementById("prev");
  const next=document.getElementById("next");
  const today=document.getElementById("today");
  const upList=document.getElementById("upList");
  const search=document.getElementById("search");
  const eventDialog=document.getElementById("eventDialog");
  const closeDlg=document.getElementById("closeDlg");
  const saveBtn=document.getElementById("saveBtn");
  const deleteBtn=document.getElementById("deleteBtn");
  const titleInput=document.getElementById("titleInput");
  const dateInput=document.getElementById("dateInput");
  const timeInput=document.getElementById("timeInput");
  const catInput=document.getElementById("catInput");
  const notesInput=document.getElementById("notesInput");
  let editing=null;

  // Helpers
  function pad(n){return n.toString().padStart(2,"0")}
  function fmtDate(d){return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())}
  function startOfMonth(d){return new Date(d.getFullYear(), d.getMonth(), 1)}
  function endOfMonth(d){return new Date(d.getFullYear(), d.getMonth()+1, 0)}

  // Very simple liturgical tint (unchanged)
  function liturgicalFor(date){
    const m=date.getMonth()+1;
    if(m===12) return {name:"Advent/Christmas", color:"#ede9fe"};
    if(m===1)  return {name:"Epiphany", color:"#f1f5f9"};
    if(m===2 || m===3) return {name:"Lent", color:"#ede9fe"};
    if(m===4 || m===5) return {name:"Easter", color:"#f1f5f9"};
    if(m>=6 && m<=10) return {name:"Ordinary", color:"#ecfdf5"};
    if(m===11) return {name:"Christ the King", color:"#fffbeb"};
    return {name:"Ordinary", color:"#ecfdf5"};
  }

  /* ============================
     RECURRING EVENTS (AA/NA)
     ============================ */

  // Map: 0=Sun,1=Mon,2=Tue,3=Wed,4=Thu,5=Fri,6=Sat
  // Matches your “Recovery Groups” buttons (AA Tue/Fri 7pm, NA Thu 7pm, Sun 5:30pm)
  const recurringEvents = [
    { title:"AA Group 148", cat:"recovery", notes:"AA meeting", weekdays:[2,5], time:"19:00" }, // Tue & Fri 7:00 PM
    { title:"NA Group",     cat:"recovery", notes:"NA meeting", weekdays:[4],   time:"19:00" }, // Thu 7:00 PM
    { title:"NA Group",     cat:"recovery", notes:"NA meeting", weekdays:[0],   time:"17:30" }  // Sun 5:30 PM
  ];

  function datesForWeekdayInMonth(year, monthIndex, weekday0to6){
    const first = new Date(year, monthIndex, 1);
    const last  = new Date(year, monthIndex+1, 0);
    const dates = [];
    let d = new Date(first);
    while (d.getDay() !== weekday0to6) d.setDate(d.getDate()+1);
    while (d <= last){
      dates.push(new Date(d));
      d.setDate(d.getDate()+7);
    }
    return dates;
  }

  function expandRecurringForMonth(viewDate){
    const y=viewDate.getFullYear(), m=viewDate.getMonth();
    const out=[];
    for(const r of recurringEvents){
      for(const wd of r.weekdays){
        for(const d of datesForWeekdayInMonth(y,m,wd)){
          out.push({
            id:`rec-${r.title}-${wd}-${fmtDate(d)}`,
            title:r.title,
            date:fmtDate(d),
            time:r.time,
            cat:r.cat,
            notes:r.notes
          });
        }
      }
    }
    return out;
  }

  /* ============================
     RENDER
     ============================ */
  function render(){
    // Label
    monthLabel.textContent = new Intl.DateTimeFormat("en-US",{month:"long",year:"numeric"}).format(current);

    // Build combined event list for the visible month
    const stored = JSON.parse(localStorage.getItem("churchEvents")||"[]");
    const recurringThisMonth = expandRecurringForMonth(current);
    const displayEvents = [...stored, ...recurringThisMonth];

    // Grid
    grid.innerHTML="";
    const first = startOfMonth(current);
    const last  = endOfMonth(current);
    const start = new Date(first);
    start.setDate(first.getDate() - ((first.getDay()+7)%7)); // back to Sunday

    const days = Math.ceil(((last - start)/(1000*60*60*24) + last.getDay()+1));
    const total = Math.ceil(days/7)*7;

    for(let i=0;i<total;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const cell = document.createElement("div");
      cell.className="day"+((d.getMonth()==current.getMonth())?"":" out")+((i%14<7)?" alt":"");

      // Season tint
      if(document.getElementById("showHoly").checked){
        const season = liturgicalFor(d);
        cell.style.background = `linear-gradient(0deg, ${season.color}, #ffffff 80%)`;
      }

      cell.innerHTML += `
        <div class="date">${d.getDate()}</div>
        <div class="events"></div>
      `;
      if(fmtDate(d)===fmtDate(new Date())) cell.classList.add("today");

      // Day events
      const wrap = cell.querySelector(".events");
      const dayStr = fmtDate(d);
      displayEvents
        .filter(e => e.date===dayStr)
        .forEach(e=>{
          const chip=document.createElement("div");
          chip.className="event";
          const sw=document.createElement("span");
          sw.className="swatch";
          if(e.cat==="service") sw.style.background="#bef264";
          else if(e.cat==="recovery") sw.style.background="#93c5fd";
          else sw.style.background="#fca5a5";
          chip.appendChild(sw);
          chip.appendChild(document.createTextNode((e.time?e.time+" ":"")+e.title));
          wrap.appendChild(chip);
        });

      grid.appendChild(cell);
    }

    // Upcoming (combined list)
    const todayStr = fmtDate(new Date());
    const upcoming = displayEvents
      .filter(e => e.date >= todayStr)
      .sort((a,b)=> (eKey(a)).localeCompare(eKey(b)))
      .slice(0,10);

    function eKey(e){ return (e.date || "") + (e.time || ""); }

    if(!upcoming.length){
      upList.textContent = "No upcoming events. Add one above!";
    }else{
      upList.innerHTML = upcoming.map(e=>{
        const d = new Date(e.date+"T"+(e.time||"00:00"));
        const nice = new Intl.DateTimeFormat("en-US",{
          weekday:"short", month:"short", day:"numeric",
          hour:"numeric", minute:"2-digit"
        }).format(d);
        return `<div class="up-item"><div class="date">${nice}</div><div class="title">${e.title}</div><div class="small">${e.notes||""}</div></div>`;
      }).join("");
    }
  }

  /* ============================
     DEFAULT SEED (unchanged)
     ============================ */
  if (!events || !Array.isArray(events) || !events.length) {
    events = [
      {id:1, title:"Sunday Service", date: new Date().toISOString().slice(0,10), time:"10:00", cat:"service", notes:"All are welcome"},
      {id:2, title:"AA Group 148",   date: new Date().toISOString().slice(0,10), time:"19:00", cat:"recovery"},
      {id:3, title:"NA Group",       date: new Date().toISOString().slice(0,10), time:"17:30", cat:"recovery"}
    ];
    localStorage.setItem("churchEvents", JSON.stringify(events));
  }

  /* ============================
     CONTROLS & DIALOG (unchanged)
     ============================ */
  prev.onclick=()=>{current.setMonth(current.getMonth()-1);render()}
  next.onclick=()=>{current.setMonth(current.getMonth()+1);render()}
  today.onclick=()=>{current=new Date();render()}
  document.getElementById("showUSA").onchange=()=>{render()}
  document.getElementById("showHoly").onchange=()=>{render()}
  search.oninput=(e)=>{
    const q=e.target.value.toLowerCase();
    document.querySelectorAll(".event").forEach(el=>{
      el.style.display=el.textContent.toLowerCase().includes(q)?"":"none";
    });
  }

  const openAdd=document.getElementById("openAdd");
  openAdd.onclick=()=>{
    editing=null;
    document.getElementById("dlgTitle").textContent="Add Event";
    dateInput.value=(new Date()).toISOString().substr(0,10);
    timeInput.value="10:00";
    titleInput.value="";
    catInput.value="special";
    notesInput.value="";
    deleteBtn.style.display="none";
    eventDialog.showModal();
  };
  closeDlg.onclick=()=>eventDialog.close();
  saveBtn.onclick=(ev)=>{
    ev.preventDefault();
    const item={
      id: editing || Date.now(),
      title: titleInput.value || "Untitled",
      date: dateInput.value,
      time: timeInput.value || "00:00",
      cat:  catInput.value,
      notes: notesInput.value
    };
    if(editing){ events = events.map(e => e.id===editing ? item : e); }
    else{ events.push(item); }
    localStorage.setItem("churchEvents",JSON.stringify(events));
    eventDialog.close(); render();
  };
  deleteBtn.onclick=(ev)=>{
    ev.preventDefault();
    events = events.filter(e => e.id!==editing);
    localStorage.setItem("churchEvents",JSON.stringify(events));
    eventDialog.close(); render();
  };

  render();
</script>

