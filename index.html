<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trinity Episcopal De Soto â€” Calendar</title>
  <meta name="description" content="Monthly events & services at Trinity Episcopal Church, De Soto, MO. All are welcome." />
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --panel:#ffffff; --ink:#0e1726; --muted:#475569;
      --grid:#e5e7eb; --accent:#16a34a; --accent-2:#2563eb; --chip:#eafaf0;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--ink);background:#fff}
    .app{max-width:980px;margin:14px auto;padding:12px}
    .banner{background: radial-gradient(1200px 600px at 10% -20%, #1b3a9c, #7c3aed 60%, #0ea5e9 100%); color:#fff;padding:40px 16px;margin-bottom:12px}
    .brand{font-weight:800;font-size:32px}
    .subtitle{margin:0 0 8px 0;opacity:.85}

    /* cover */
    .cover{max-width:980px;margin:14px auto;padding:0 12px}
    .cover-card{background:#0b1220 url('assets/view-calendar.png?v='+Math.random()) center/cover no-repeat;border-radius:20px;min-height:220px;display:flex;align-items:end;justify-content:end;overflow:hidden}
    .cover-veil{backdrop-filter: blur(2px);background:rgba(0,0,0,.35);width:100%;height:100%;position:relative}
    .cover-btn{position:absolute;right:14px;bottom:14px;background:#16a34a;color:#fff;border:none;border-radius:999px;padding:10px 16px;font-weight:800;cursor:pointer}

    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:10px 0}
    .chip{background:var(--chip);color:#14532d;border-radius:999px;padding:4px 10px;font-weight:600;font-size:12px}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:999px;padding:8px 14px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
    .dow{opacity:.7;font-size:12px;font-weight:700;text-align:center}
    .cell{border:1px solid var(--grid);border-radius:16px;min-height:120px;padding:8px;position:relative}
    .date{position:absolute;top:6px;right:10px;font-size:12px;color:var(--muted)}
    .event{margin-top:22px;background:#f8fafc;border-radius:12px;padding:6px 8px;border:1px solid #e5e7eb}
    .event a{font-size:12px;text-decoration:none}

    .affirm{max-width:980px;margin:20px auto 40px;padding:12px;border-top:1px solid var(--grid);color:var(--muted)}
  </style>
</head>
<body>
  <div class="banner">
    <div class="app" style="color:#fff">
      <div class="brand">Trinity Episcopal De Soto â€” Calendar</div>
      <p class="subtitle">Monthly events & services at Trinity Episcopal Church, De Soto, MO. All are welcome.</p>
    </div>
  </div>

  <!-- Cover image that can hide/show the calendar -->
  <div class="cover" id="cover" style="display:none">
    <div class="cover-card">
      <div class="cover-veil">
        <button class="cover-btn" id="showCalendar">View Calendar</button>
      </div>
    </div>
  </div>

  <!-- Calendar app -->
  <div class="app" id="calendarApp" style="display:block">
    <div class="controls">
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn" id="prev">â—€</button>
        <h2 id="monthlabel" style="margin:0"></h2>
        <span id="season" class="chip">Ordinary Time</span>
        <button class="btn" id="next">â–¶</button>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn" data-btn="today">Today</button>
        <button class="btn" id="print">ðŸ–¨ Print</button>
        <button class="btn" id="hide">Hide</button>
      </div>
    </div>

    <div class="grid" id="dow"></div>
    <div class="grid" id="grid"></div>
  </div>

  <div class="affirm" id="affirm"></div>

  <script>
  <!-- =============================
Trinity Calendar â€” Dropâ€‘in fixes
1) Replace the entire /assets/events.json with the JSON below.
2) In index.html, bump ASSETS_VERSION and paste the <script> block below
   just before the closing </body>.
3) Hard refresh (Cmd+Shift+R) after each change.
============================= -->

<!-- ===== (1) /assets/events.json ===== -->
<script type="application/json" data-filename="assets/events.json">
[
  {
    "affirmationLabel": "Daily Affirmation",
    "affirmationURL": "",
    "dioceseICS": "https://www.lectionarypage.net/Resources/LiturgicalCalendar.ics",
    "affirmationText": "May these days remind us: Godâ€™s love is present in every season."
  },

  { "id": "first-sunday-carry-in", "title": "First Sunday Carry-In Dinner", "location": "Parish Hall â€” Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=MONTHLY;BYDAY=SU;BYSETPOS=1", "dtstart": "2025-01-05T12:00:00" }, "durationMinutes": 90 },

  { "id": "aa-148-tue", "title": "AA Group 148", "location": "Parish Hall â€” Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=WEEKLY;BYDAY=TU", "dtstart": "2025-01-07T19:00:00" }, "durationMinutes": 60 },
  { "id": "aa-147-fri", "title": "AA Group 147", "location": "Parish Hall â€” Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=WEEKLY;BYDAY=FR", "dtstart": "2025-01-03T19:00:00" }, "durationMinutes": 60 },
  { "id": "na-thu", "title": "NA (Narcotics Anonymous)", "location": "Parish Hall â€” Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=WEEKLY;BYDAY=TH", "dtstart": "2025-01-09T19:00:00" }, "durationMinutes": 60 },
  { "id": "na-sun", "title": "NA (Narcotics Anonymous)", "location": "Parish Hall â€” Trinity Episcopal Church", "timeZone": "America/Chicago", "recurrence": { "rrule": "FREQ=WEEKLY;BYDAY=SU", "dtstart": "2025-01-05T17:30:00" }, "durationMinutes": 60 },

  { "id": "new-years-2025", "title": "New Year's Day (State/Federal)", "location": "USA/Missouri", "timeZone": "America/Chicago", "start": "2025-01-01T00:00:00", "durationMinutes": 0 },
  { "id": "mlk-2025", "title": "Martin Luther King, Jr.â€™s Birthday (State/Federal)", "location": "USA/Missouri", "timeZone": "America/Chicago", "start": "2025-01-20T00:00:00", "durationMinutes": 0 },
  { "id": "lincoln-2025", "title": "Lincoln's Birthday (Missouri)", "location": "Missouri, USA", "timeZone": "America/Chicago", "start": "2025-02-12T00:00:00", "durationMinutes": 0 },
  { "id": "washington-2025", "title": "Washington's Birthday (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-02-17T00:00:00", "durationMinutes": 0 },
  { "id": "truman-day-2025", "title": "Truman Day (Missouri)", "location": "Missouri, USA", "timeZone": "America/Chicago", "start": "2025-05-08T00:00:00", "durationMinutes": 0 },
  { "id": "memorial-2025", "title": "Memorial Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-05-26T00:00:00", "durationMinutes": 0 },
  { "id": "juneteenth-2025", "title": "Juneteenth (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-06-19T00:00:00", "durationMinutes": 0 },
  { "id": "independence-2025", "title": "Independence Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-07-04T00:00:00", "durationMinutes": 0 },
  { "id": "labor-2025", "title": "Labor Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-09-01T00:00:00", "durationMinutes": 0 },
  { "id": "columbus-2025", "title": "Columbus Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-10-13T00:00:00", "durationMinutes": 0 },
  { "id": "veterans-2025", "title": "Veterans Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-11-11T00:00:00", "durationMinutes": 0 },
  { "id": "thanksgiving-2025", "title": "Thanksgiving Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-11-27T00:00:00", "durationMinutes": 0 },
  { "id": "christmas-2025", "title": "Christmas Day (Federal)", "location": "USA", "timeZone": "America/Chicago", "start": "2025-12-25T00:00:00", "durationMinutes": 0 }
]
</script>


<!-- ===== (2) index.html â€” drop this before </body>  ===== -->
<script>
  // ***** BUMP THIS NUMBER ANY TIME events.json OR THIS SCRIPT CHANGES *****
  const ASSETS_VERSION = 255;

  // Where to load events from (no leading slash)
  const EVENTS_URLS = [
    'assets/events.json?v=' + ASSETS_VERSION,
    'admin/events.json?v=' + ASSETS_VERSION // optional fallback if using CMS
  ];

  // Basic router state
  const state = { year: 0, month: 0 }; // month 0â€“11

  // ---- Fetch helpers ----
  async function loadEvents() {
    const attempts = EVENTS_URLS.map(url =>
      fetch(url, { cache: 'no-store' }).then(r => {
        if (!r.ok) throw new Error(url + ' ' + r.status);
        return r.json();
      })
    );
    // Try fastest path
    try { return await Promise.any(attempts); } catch {}
    // Fallback: try serially
    for (const url of EVENTS_URLS) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (r.ok) return await r.json();
      } catch {}
    }
    throw new Error('No events.json sources reachable');
  }

  // ---- Date helpers ----
  const pad = n => String(n).padStart(2, '0');
  const TZ_DEFAULT = 'America/Chicago';

  function addMinutes(iso, mins) {
    const d = new Date(iso);
    d.setMinutes(d.getMinutes() + (mins || 0));
    return d.toISOString();
  }

  // Expand minimal RRULEs (WEEKLY, MONTHLY with BYDAY & BYSETPOS=1..5)
  function expandRecurrence(ev, rangeStartISO, rangeEndISO) {
    const out = [];
    if (!ev.recurrence) return out;
    const { rrule, dtstart } = ev.recurrence;
    if (!rrule || !dtstart) return out;

    const start = new Date(rangeStartISO);
    const end   = new Date(rangeEndISO);

    const rule = Object.fromEntries(rrule.split(';').map(kv => kv.split('=')));
    const freq = rule.FREQ;

    if (freq === 'WEEKLY') {
      const byday = (rule.BYDAY || '').split(','); // e.g., ["TU"]
      // start from the week of dtstart
      let cursor = new Date(dtstart);
      // move cursor back to range start if needed
      if (cursor < start) cursor = new Date(start);

      const weekdayIndex = { SU:0, MO:1, TU:2, WE:3, TH:4, FR:5, SA:6 };

      while (cursor <= end) {
        for (const code of byday) {
          const inst = new Date(cursor);
          const want = weekdayIndex[code];
          const diff = (want - inst.getDay() + 7) % 7;
          inst.setDate(inst.getDate() + diff);
          const instanceISO = new Date(
            inst.getFullYear(), inst.getMonth(), inst.getDate(),
            new Date(dtstart).getHours(), new Date(dtstart).getMinutes(), 0
          ).toISOString();
          if (inst >= start && inst <= end) {
            out.push({ start: instanceISO, end: addMinutes(instanceISO, ev.durationMinutes || 60) });
          }
        }
        cursor.setDate(cursor.getDate() + 7); // next week
      }
    }

    if (freq === 'MONTHLY') {
      const byday = (rule.BYDAY || '').split(','); // e.g., ["SU"]
      const bysetpos = parseInt(rule.BYSETPOS || '1', 10); // e.g., 1 = first
      let cursor = new Date(dtstart);
      if (cursor < start) cursor = new Date(start);

      const weekdayIndex = { SU:0, MO:1, TU:2, WE:3, TH:4, FR:5, SA:6 };

      while (cursor <= end) {
        const y = cursor.getFullYear();
        const m = cursor.getMonth();
        for (const code of byday) {
          // find the Nth weekday of the month
          const firstOfMonth = new Date(y, m, 1);
          const firstDow = firstOfMonth.getDay();
          const want = weekdayIndex[code];
          const day = 1 + ((want - firstDow + 7) % 7) + (bysetpos - 1) * 7;
          const inst = new Date(y, m, day, new Date(dtstart).getHours(), new Date(dtstart).getMinutes(), 0);
          if (inst >= start && inst <= end && inst.getMonth() === m) {
            const instanceISO = inst.toISOString();
            out.push({ start: instanceISO, end: addMinutes(instanceISO, ev.durationMinutes || 60) });
          }
        }
        // next month
        cursor = new Date(y, m + 1, 1);
      }
    }

    return out;
  }

  // ---- Google link helper ----
  function toGoogleUTC(dt) {
    const d = new Date(dt);
    return (
      d.getUTCFullYear() +
      pad(d.getUTCMonth() + 1) +
      pad(d.getUTCDate()) + 'T' +
      pad(d.getUTCHours()) +
      pad(d.getUTCMinutes()) + '00Z'
    );
  }

  function googleLink(ev, startISO, endISO) {
    const text = encodeURIComponent(ev.title);
    const dates = `${toGoogleUTC(startISO)}/${toGoogleUTC(endISO)}`;
    const loc = encodeURIComponent(ev.location || '');
    const tz = encodeURIComponent(ev.timeZone || TZ_DEFAULT);
    const det = encodeURIComponent('Trinity Episcopal De Soto â€” Calendar');
    return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&dates=${dates}&location=${loc}&details=${det}&ctz=${tz}`;
  }

  // ---- Today button ----
  function goTo(y, m) {
    state.year = y; state.month = m; render?.(); // assumes you already have render()
    location.hash = `#/${y}/${String(m + 1).padStart(2, '0')}`;
  }
  function goToToday() {
    const now = new Date();
    goTo(now.getFullYear(), now.getMonth());
  }
  document.querySelector('[data-btn="today"]')?.addEventListener('click', goToToday);
  if (!location.hash) goToToday();

  // ---- Example hook during render (pseudo):
  // When you render an expanded event instance, add the Google button like this:
  // const a = document.createElement('a');
  // a.href = googleLink(ev, instance.start, instance.end);
  // a.target = '_blank';
  // a.rel = 'noopener';
  // a.textContent = 'Add to Google';
  // card.appendChild(a);

  // Optional: quick probe in console to debug fetch
  window._probeEvents = async () => {
    const u = 'assets/events.json?probe=' + Date.now();
    const r = await fetch(u, { cache: 'no-store' });
    const t = await r.text();
    console.log('status', r.status, 'bytes', t.length);
    try { JSON.parse(t); console.log('JSON OK'); } catch(e) { console.warn('JSON parse error', e); }
  };
</script>

</body>
 </html>
</html>
